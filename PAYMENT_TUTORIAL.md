# ğŸ’° çº¿ä¸Šæ”¯ä»˜åŠŸèƒ½å®ç°å®Œæ•´æ•™ç¨‹

## ğŸ“– ç›®å½•

1. [æ”¯ä»˜åŸºç¡€çŸ¥è¯†](#æ”¯ä»˜åŸºç¡€çŸ¥è¯†)
2. [æ”¯ä»˜æµç¨‹è¯¦è§£](#æ”¯ä»˜æµç¨‹è¯¦è§£)
3. [æŠ€æœ¯é€‰å‹](#æŠ€æœ¯é€‰å‹)
4. [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
5. [ä»£ç å®ç°](#ä»£ç å®ç°)
6. [æµ‹è¯•æ–¹æ³•](#æµ‹è¯•æ–¹æ³•)
7. [å®‰å…¨æ³¨æ„äº‹é¡¹](#å®‰å…¨æ³¨æ„äº‹é¡¹)
8. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ“š æ”¯ä»˜åŸºç¡€çŸ¥è¯†

### ä»€ä¹ˆæ˜¯çº¿ä¸Šæ”¯ä»˜ï¼Ÿ

çº¿ä¸Šæ”¯ä»˜æ˜¯æŒ‡ç”¨æˆ·é€šè¿‡äº’è”ç½‘å®Œæˆæ”¯ä»˜çš„è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ï¼š
- å¾®ä¿¡æ”¯ä»˜
- æ”¯ä»˜å®æ”¯ä»˜
- é“¶è¡Œå¡æ”¯ä»˜
- å›½é™…æ”¯ä»˜ï¼ˆStripeã€PayPalç­‰ï¼‰

### æ”¯ä»˜çš„æ ¸å¿ƒæ¦‚å¿µ

#### 1. å•†æˆ·å·ï¼ˆMerchant IDï¼‰
- æ”¯ä»˜å¹³å°åˆ†é…ç»™å•†å®¶çš„å”¯ä¸€æ ‡è¯†
- ç”¨äºè¯†åˆ«æ”¶æ¬¾æ–¹
- éœ€è¦ä¼ä¸šèµ„è´¨ç”³è¯·

#### 2. APIå¯†é’¥ï¼ˆAPI Key/Secretï¼‰
- ç”¨äºéªŒè¯è¯·æ±‚çš„åˆæ³•æ€§
- éœ€è¦å¦¥å–„ä¿ç®¡ï¼Œä¸èƒ½æ³„éœ²
- é€šå¸¸åŒ…æ‹¬ï¼š
  - App IDï¼šåº”ç”¨æ ‡è¯†
  - App Secretï¼šåº”ç”¨å¯†é’¥
  - API Keyï¼šæ¥å£å¯†é’¥

#### 3. å›è°ƒé€šçŸ¥ï¼ˆCallback/Webhookï¼‰
- æ”¯ä»˜å®Œæˆåï¼Œæ”¯ä»˜å¹³å°ä¸»åŠ¨é€šçŸ¥å•†æˆ·
- å•†æˆ·éœ€è¦æä¾›ä¸€ä¸ªå…¬ç½‘å¯è®¿é—®çš„URL
- ç”¨äºæ›´æ–°è®¢å•çŠ¶æ€

#### 4. è®¢å•å·ï¼ˆOrder IDï¼‰
- å•†æˆ·ç³»ç»Ÿç”Ÿæˆçš„å”¯ä¸€è®¢å•æ ‡è¯†
- ç”¨äºå…³è”æ”¯ä»˜å’Œä¸šåŠ¡è®¢å•
- å¿…é¡»ä¿è¯å”¯ä¸€æ€§

---

## ğŸ”„ æ”¯ä»˜æµç¨‹è¯¦è§£

### å®Œæ•´æ”¯ä»˜æµç¨‹ï¼ˆä»¥å¾®ä¿¡æ”¯ä»˜ä¸ºä¾‹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·   â”‚         â”‚  å•†æˆ·   â”‚         â”‚  å¾®ä¿¡   â”‚         â”‚  é“¶è¡Œ   â”‚
â”‚  å‰ç«¯   â”‚         â”‚  åç«¯   â”‚         â”‚  æ”¯ä»˜   â”‚         â”‚         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                   â”‚                   â”‚                   â”‚
     â”‚ 1. å‘èµ·æ”¯ä»˜è¯·æ±‚   â”‚                   â”‚                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                   â”‚
     â”‚                   â”‚                   â”‚                   â”‚
     â”‚                   â”‚ 2. åˆ›å»ºæ”¯ä»˜è®¢å•   â”‚                   â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
     â”‚                   â”‚                   â”‚                   â”‚
     â”‚                   â”‚ 3. è¿”å›æ”¯ä»˜å‚æ•°   â”‚                   â”‚
     â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                   â”‚                   â”‚                   â”‚
     â”‚ 4. è¿”å›æ”¯ä»˜ä¿¡æ¯   â”‚                   â”‚                   â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                   â”‚
     â”‚                   â”‚                   â”‚                   â”‚
     â”‚ 5. è°ƒèµ·æ”¯ä»˜ç•Œé¢   â”‚                   â”‚                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
     â”‚                   â”‚                   â”‚                   â”‚
     â”‚                   â”‚                   â”‚ 6. è¯·æ±‚æ‰£æ¬¾       â”‚
     â”‚                   â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                   â”‚                   â”‚                   â”‚
     â”‚                   â”‚                   â”‚ 7. æ‰£æ¬¾æˆåŠŸ       â”‚
     â”‚                   â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                   â”‚                   â”‚                   â”‚
     â”‚ 8. æ”¯ä»˜æˆåŠŸæç¤º   â”‚                   â”‚                   â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                   â”‚                   â”‚                   â”‚
     â”‚                   â”‚ 9. å¼‚æ­¥é€šçŸ¥       â”‚                   â”‚
     â”‚                   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                   â”‚                   â”‚                   â”‚
     â”‚                   â”‚ 10. æ›´æ–°è®¢å•çŠ¶æ€  â”‚                   â”‚
     â”‚                   â”‚                   â”‚                   â”‚
     â”‚                   â”‚ 11. è¿”å›æˆåŠŸ      â”‚                   â”‚
     â”‚                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
     â”‚                   â”‚                   â”‚                   â”‚
     â”‚ 12. æŸ¥è¯¢è®¢å•çŠ¶æ€  â”‚                   â”‚                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚                   â”‚
     â”‚                   â”‚                   â”‚                   â”‚
     â”‚ 13. è¿”å›æ”¯ä»˜ç»“æœ  â”‚                   â”‚                   â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                   â”‚
     â”‚                   â”‚                   â”‚                   â”‚
```

### å…³é”®æ­¥éª¤è¯´æ˜

#### æ­¥éª¤1-4ï¼šåˆ›å»ºæ”¯ä»˜è®¢å•
- ç”¨æˆ·ç‚¹å‡»"æ”¯ä»˜"æŒ‰é’®
- å‰ç«¯å‘é€æ”¯ä»˜è¯·æ±‚åˆ°åç«¯
- åç«¯è°ƒç”¨æ”¯ä»˜å¹³å°APIåˆ›å»ºè®¢å•
- è¿”å›æ”¯ä»˜å‚æ•°ç»™å‰ç«¯

#### æ­¥éª¤5-8ï¼šç”¨æˆ·å®Œæˆæ”¯ä»˜
- å‰ç«¯è°ƒèµ·æ”¯ä»˜ç•Œé¢ï¼ˆå¾®ä¿¡/æ”¯ä»˜å®ï¼‰
- ç”¨æˆ·è¾“å…¥å¯†ç å®Œæˆæ”¯ä»˜
- æ”¯ä»˜å¹³å°æ‰£æ¬¾
- æ˜¾ç¤ºæ”¯ä»˜ç»“æœ

#### æ­¥éª¤9-11ï¼šå¼‚æ­¥é€šçŸ¥ï¼ˆæœ€é‡è¦ï¼‰
- æ”¯ä»˜å¹³å°ä¸»åŠ¨é€šçŸ¥å•†æˆ·åç«¯
- å•†æˆ·éªŒè¯é€šçŸ¥çš„çœŸå®æ€§
- æ›´æ–°è®¢å•çŠ¶æ€
- è¿”å›æˆåŠŸå“åº”

#### æ­¥éª¤12-13ï¼šæŸ¥è¯¢ç»“æœ
- å‰ç«¯æŸ¥è¯¢è®¢å•çŠ¶æ€
- æ˜¾ç¤ºæ”¯ä»˜ç»“æœç»™ç”¨æˆ·

---

## ğŸ¯ æŠ€æœ¯é€‰å‹

### å›½å†…æ”¯ä»˜æ–¹å¼

#### 1. å¾®ä¿¡æ”¯ä»˜
- **ä¼˜åŠ¿**ï¼šç”¨æˆ·åŸºæ•°å¤§ï¼Œä½¿ç”¨æ–¹ä¾¿
- **é€‚ç”¨åœºæ™¯**ï¼šH5ã€å°ç¨‹åºã€Appã€æ‰«ç æ”¯ä»˜
- **ç”³è¯·è¦æ±‚**ï¼šä¼ä¸šèµ„è´¨ã€è¥ä¸šæ‰§ç…§
- **è´¹ç‡**ï¼š0.6%ï¼ˆä¸€èˆ¬å•†æˆ·ï¼‰
- **å®˜æ–¹æ–‡æ¡£**ï¼šhttps://pay.weixin.qq.com/

#### 2. æ”¯ä»˜å®æ”¯ä»˜
- **ä¼˜åŠ¿**ï¼šä¿¡ä»»åº¦é«˜ï¼Œæ”¯æŒå¤šç§åœºæ™¯
- **é€‚ç”¨åœºæ™¯**ï¼šç½‘é¡µã€Appã€æ‰«ç æ”¯ä»˜
- **ç”³è¯·è¦æ±‚**ï¼šä¼ä¸šèµ„è´¨ã€è¥ä¸šæ‰§ç…§
- **è´¹ç‡**ï¼š0.6%ï¼ˆä¸€èˆ¬å•†æˆ·ï¼‰
- **å®˜æ–¹æ–‡æ¡£**ï¼šhttps://open.alipay.com/

### å›½é™…æ”¯ä»˜æ–¹å¼

#### 3. Stripe
- **ä¼˜åŠ¿**ï¼šå¼€å‘å‹å¥½ï¼Œæ–‡æ¡£å®Œå–„
- **é€‚ç”¨åœºæ™¯**ï¼šå›½é™…ä¿¡ç”¨å¡æ”¯ä»˜
- **ç”³è¯·è¦æ±‚**ï¼šç›¸å¯¹ç®€å•
- **è´¹ç‡**ï¼š2.9% + $0.30/ç¬”
- **å®˜æ–¹æ–‡æ¡£**ï¼šhttps://stripe.com/docs

#### 4. PayPal
- **ä¼˜åŠ¿**ï¼šå›½é™…çŸ¥ååº¦é«˜
- **é€‚ç”¨åœºæ™¯**ï¼šè·¨å¢ƒæ”¯ä»˜
- **ç”³è¯·è¦æ±‚**ï¼šä¸ªäººæˆ–ä¼ä¸šå‡å¯
- **è´¹ç‡**ï¼š3.4% + å›ºå®šè´¹ç”¨
- **å®˜æ–¹æ–‡æ¡£**ï¼šhttps://developer.paypal.com/

### æœ¬æ•™ç¨‹é€‰æ‹©

æˆ‘ä»¬å°†å®ç°ï¼š
1. **æ¨¡æ‹Ÿæ”¯ä»˜**ï¼ˆç”¨äºå¼€å‘æµ‹è¯•ï¼Œæ— éœ€çœŸå®å•†æˆ·å·ï¼‰
2. **Stripeæ”¯ä»˜**ï¼ˆçœŸå®æ”¯ä»˜ï¼Œç”³è¯·ç®€å•ï¼Œé€‚åˆå­¦ä¹ ï¼‰
3. **å¾®ä¿¡/æ”¯ä»˜å®æ”¯ä»˜æ¡†æ¶**ï¼ˆæä¾›ä»£ç æ¡†æ¶ï¼Œéœ€è¦å•†æˆ·å·ï¼‰

---

## ğŸ› ï¸ ç¯å¢ƒå‡†å¤‡

### 1. æ³¨å†ŒStripeè´¦å·ï¼ˆç”¨äºçœŸå®æ”¯ä»˜æµ‹è¯•ï¼‰

```bash
# è®¿é—®Stripeå®˜ç½‘
https://stripe.com/

# æ³¨å†Œè´¦å·ï¼ˆå…è´¹ï¼‰
# è·å–æµ‹è¯•å¯†é’¥ï¼š
# - Publishable keyï¼ˆå…¬å¼€å¯†é’¥ï¼Œå‰ç«¯ä½¿ç”¨ï¼‰
# - Secret keyï¼ˆç§å¯†å¯†é’¥ï¼Œåç«¯ä½¿ç”¨ï¼‰
```

### 2. å®‰è£…Stripe SDK

```bash
# å®‰è£…Stripe Node.js SDK
npm install stripe

# å®‰è£…Stripe Reactç»„ä»¶
npm install @stripe/stripe-js @stripe/react-stripe-js
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

åœ¨`.env`æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```env
# Stripeé…ç½®
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_xxxxx
STRIPE_SECRET_KEY=sk_test_xxxxx

# æ”¯ä»˜å›è°ƒåœ°å€
VITE_PAYMENT_CALLBACK_URL=https://your-domain.com/api/payment/callback
```

---

## ğŸ’» ä»£ç å®ç°

### æ•°æ®åº“è®¾è®¡

#### 1. æ”¯ä»˜è®¢å•è¡¨ï¼ˆpayment_ordersï¼‰

```sql
CREATE TABLE payment_orders (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  order_no VARCHAR(64) UNIQUE NOT NULL,           -- è®¢å•å·
  dealership_id UUID REFERENCES dealerships(id),  -- è½¦è¡ŒID
  user_id UUID REFERENCES auth.users(id),         -- ç”¨æˆ·ID
  
  -- è®¢å•ä¿¡æ¯
  amount DECIMAL(10, 2) NOT NULL,                 -- æ”¯ä»˜é‡‘é¢
  currency VARCHAR(3) DEFAULT 'CNY',              -- è´§å¸ç±»å‹
  subject VARCHAR(256) NOT NULL,                  -- è®¢å•æ ‡é¢˜
  description TEXT,                               -- è®¢å•æè¿°
  
  -- æ”¯ä»˜ä¿¡æ¯
  payment_method VARCHAR(32),                     -- æ”¯ä»˜æ–¹å¼ï¼šwechat/alipay/stripe
  payment_status VARCHAR(32) DEFAULT 'pending',   -- æ”¯ä»˜çŠ¶æ€ï¼špending/paid/failed/refunded
  payment_time TIMESTAMP,                         -- æ”¯ä»˜æ—¶é—´
  
  -- ç¬¬ä¸‰æ–¹ä¿¡æ¯
  transaction_id VARCHAR(128),                    -- ç¬¬ä¸‰æ–¹äº¤æ˜“å·
  payment_data JSONB,                             -- æ”¯ä»˜å¹³å°è¿”å›çš„æ•°æ®
  
  -- ä¸šåŠ¡å…³è”
  business_type VARCHAR(32),                      -- ä¸šåŠ¡ç±»å‹ï¼šmembership/deposit/vehicle
  business_id UUID,                               -- ä¸šåŠ¡ID
  
  -- æ—¶é—´æˆ³
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_payment_orders_order_no ON payment_orders(order_no);
CREATE INDEX idx_payment_orders_user_id ON payment_orders(user_id);
CREATE INDEX idx_payment_orders_status ON payment_orders(payment_status);
CREATE INDEX idx_payment_orders_transaction_id ON payment_orders(transaction_id);
```

#### 2. æ”¯ä»˜å›è°ƒæ—¥å¿—è¡¨ï¼ˆpayment_callbacksï¼‰

```sql
CREATE TABLE payment_callbacks (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  order_no VARCHAR(64) NOT NULL,                  -- è®¢å•å·
  payment_method VARCHAR(32),                     -- æ”¯ä»˜æ–¹å¼
  callback_data JSONB,                            -- å›è°ƒæ•°æ®
  is_verified BOOLEAN DEFAULT FALSE,              -- æ˜¯å¦éªŒè¯é€šè¿‡
  is_processed BOOLEAN DEFAULT FALSE,             -- æ˜¯å¦å·²å¤„ç†
  error_message TEXT,                             -- é”™è¯¯ä¿¡æ¯
  created_at TIMESTAMP DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_payment_callbacks_order_no ON payment_callbacks(order_no);
CREATE INDEX idx_payment_callbacks_created_at ON payment_callbacks(created_at);
```

### åç«¯å®ç°

#### 1. åˆ›å»ºSupabase Edge Functionï¼šåˆ›å»ºæ”¯ä»˜è®¢å•

```typescript
// supabase/functions/create-payment/index.ts

import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
import Stripe from 'https://esm.sh/stripe@13.0.0'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

serve(async (req) => {
  // å¤„ç†CORSé¢„æ£€è¯·æ±‚
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    // 1. è·å–è¯·æ±‚å‚æ•°
    const { amount, currency, subject, description, businessType, businessId, paymentMethod } = await req.json()

    // 2. éªŒè¯ç”¨æˆ·èº«ä»½
    const authHeader = req.headers.get('Authorization')!
    const token = authHeader.replace('Bearer ', '')
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? '',
      { global: { headers: { Authorization: authHeader } } }
    )

    const { data: { user }, error: userError } = await supabase.auth.getUser(token)
    if (userError || !user) {
      throw new Error('æœªæˆæƒ')
    }

    // 3. ç”Ÿæˆè®¢å•å·
    const orderNo = `PAY${Date.now()}${Math.random().toString(36).substr(2, 9).toUpperCase()}`

    // 4. åˆ›å»ºæ”¯ä»˜è®¢å•è®°å½•
    const { data: order, error: orderError } = await supabase
      .from('payment_orders')
      .insert({
        order_no: orderNo,
        user_id: user.id,
        amount,
        currency: currency || 'CNY',
        subject,
        description,
        payment_method: paymentMethod,
        payment_status: 'pending',
        business_type: businessType,
        business_id: businessId,
      })
      .select()
      .single()

    if (orderError) throw orderError

    // 5. æ ¹æ®æ”¯ä»˜æ–¹å¼åˆ›å»ºæ”¯ä»˜
    let paymentData: any = {}

    if (paymentMethod === 'stripe') {
      // Stripeæ”¯ä»˜
      const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY') ?? '', {
        apiVersion: '2023-10-16',
      })

      const paymentIntent = await stripe.paymentIntents.create({
        amount: Math.round(amount * 100), // Stripeä½¿ç”¨åˆ†ä¸ºå•ä½
        currency: currency || 'cny',
        metadata: {
          order_no: orderNo,
          user_id: user.id,
        },
        description: subject,
      })

      paymentData = {
        client_secret: paymentIntent.client_secret,
        payment_intent_id: paymentIntent.id,
      }

      // æ›´æ–°è®¢å•çš„ç¬¬ä¸‰æ–¹äº¤æ˜“å·
      await supabase
        .from('payment_orders')
        .update({ transaction_id: paymentIntent.id })
        .eq('id', order.id)

    } else if (paymentMethod === 'mock') {
      // æ¨¡æ‹Ÿæ”¯ä»˜ï¼ˆç”¨äºå¼€å‘æµ‹è¯•ï¼‰
      paymentData = {
        mock: true,
        order_no: orderNo,
        amount,
        currency,
      }
    } else {
      throw new Error('ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼')
    }

    // 6. è¿”å›æ”¯ä»˜ä¿¡æ¯
    return new Response(
      JSON.stringify({
        success: true,
        data: {
          order_no: orderNo,
          order_id: order.id,
          amount,
          currency,
          payment_method: paymentMethod,
          payment_data: paymentData,
        },
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200,
      }
    )

  } catch (error) {
    console.error('åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥:', error)
    return new Response(
      JSON.stringify({
        success: false,
        error: error.message,
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 400,
      }
    )
  }
})
```

#### 2. åˆ›å»ºSupabase Edge Functionï¼šæ”¯ä»˜å›è°ƒ

```typescript
// supabase/functions/payment-callback/index.ts

import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
import Stripe from 'https://esm.sh/stripe@13.0.0'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type, stripe-signature',
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const signature = req.headers.get('stripe-signature')
    const body = await req.text()

    // 1. éªŒè¯Stripeç­¾å
    const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY') ?? '', {
      apiVersion: '2023-10-16',
    })

    const webhookSecret = Deno.env.get('STRIPE_WEBHOOK_SECRET') ?? ''
    const event = stripe.webhooks.constructEvent(body, signature!, webhookSecret)

    // 2. åˆ›å»ºSupabaseå®¢æˆ·ç«¯ï¼ˆä½¿ç”¨service_roleæƒé™ï¼‰
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
    )

    // 3. è®°å½•å›è°ƒæ—¥å¿—
    await supabase.from('payment_callbacks').insert({
      order_no: event.data.object.metadata?.order_no || '',
      payment_method: 'stripe',
      callback_data: event,
      is_verified: true,
    })

    // 4. å¤„ç†ä¸åŒçš„äº‹ä»¶ç±»å‹
    if (event.type === 'payment_intent.succeeded') {
      const paymentIntent = event.data.object
      const orderNo = paymentIntent.metadata.order_no

      // 5. æ›´æ–°è®¢å•çŠ¶æ€
      const { data: order, error: updateError } = await supabase
        .from('payment_orders')
        .update({
          payment_status: 'paid',
          payment_time: new Date().toISOString(),
          transaction_id: paymentIntent.id,
          payment_data: paymentIntent,
          updated_at: new Date().toISOString(),
        })
        .eq('order_no', orderNo)
        .select()
        .single()

      if (updateError) throw updateError

      // 6. å¤„ç†ä¸šåŠ¡é€»è¾‘
      if (order.business_type === 'membership') {
        // å¼€é€šä¼šå‘˜
        await supabase
          .from('dealerships')
          .update({
            membership_status: 'active',
            membership_expires_at: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(),
          })
          .eq('id', order.dealership_id)
      }

      // 7. æ ‡è®°å›è°ƒå·²å¤„ç†
      await supabase
        .from('payment_callbacks')
        .update({ is_processed: true })
        .eq('order_no', orderNo)
        .eq('is_processed', false)

      console.log('æ”¯ä»˜æˆåŠŸï¼Œè®¢å•å·:', orderNo)
    }

    // 8. è¿”å›æˆåŠŸå“åº”
    return new Response(
      JSON.stringify({ received: true }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200,
      }
    )

  } catch (error) {
    console.error('å¤„ç†æ”¯ä»˜å›è°ƒå¤±è´¥:', error)
    return new Response(
      JSON.stringify({ error: error.message }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 400,
      }
    )
  }
})
```

#### 3. åˆ›å»ºSupabase Edge Functionï¼šæŸ¥è¯¢æ”¯ä»˜çŠ¶æ€

```typescript
// supabase/functions/query-payment/index.ts

import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    // 1. è·å–è®¢å•å·
    const url = new URL(req.url)
    const orderNo = url.searchParams.get('order_no')

    if (!orderNo) {
      throw new Error('ç¼ºå°‘è®¢å•å·')
    }

    // 2. éªŒè¯ç”¨æˆ·èº«ä»½
    const authHeader = req.headers.get('Authorization')!
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? '',
      { global: { headers: { Authorization: authHeader } } }
    )

    const { data: { user }, error: userError } = await supabase.auth.getUser()
    if (userError || !user) {
      throw new Error('æœªæˆæƒ')
    }

    // 3. æŸ¥è¯¢è®¢å•
    const { data: order, error: orderError } = await supabase
      .from('payment_orders')
      .select('*')
      .eq('order_no', orderNo)
      .eq('user_id', user.id)
      .single()

    if (orderError) throw orderError

    // 4. è¿”å›è®¢å•ä¿¡æ¯
    return new Response(
      JSON.stringify({
        success: true,
        data: {
          order_no: order.order_no,
          amount: order.amount,
          currency: order.currency,
          subject: order.subject,
          payment_status: order.payment_status,
          payment_time: order.payment_time,
          payment_method: order.payment_method,
        },
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200,
      }
    )

  } catch (error) {
    console.error('æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€å¤±è´¥:', error)
    return new Response(
      JSON.stringify({
        success: false,
        error: error.message,
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 400,
      }
    )
  }
})
```

### å‰ç«¯å®ç°

#### 1. åˆ›å»ºæ”¯ä»˜APIå°è£…

```typescript
// src/lib/payment.ts

import { supabase } from '@/db/supabase'

export interface CreatePaymentParams {
  amount: number
  currency?: string
  subject: string
  description?: string
  businessType: string
  businessId?: string
  paymentMethod: 'stripe' | 'mock'
}

export interface PaymentOrder {
  order_no: string
  order_id: string
  amount: number
  currency: string
  payment_method: string
  payment_data: any
}

/**
 * åˆ›å»ºæ”¯ä»˜è®¢å•
 */
export async function createPayment(params: CreatePaymentParams): Promise<PaymentOrder> {
  const { data, error } = await supabase.functions.invoke('create-payment', {
    body: params,
  })

  if (error) throw error
  if (!data.success) throw new Error(data.error)

  return data.data
}

/**
 * æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
 */
export async function queryPaymentStatus(orderNo: string) {
  const { data, error } = await supabase.functions.invoke('query-payment', {
    method: 'GET',
    body: { order_no: orderNo },
  })

  if (error) throw error
  if (!data.success) throw new Error(data.error)

  return data.data
}

/**
 * æ¨¡æ‹Ÿæ”¯ä»˜ï¼ˆç”¨äºå¼€å‘æµ‹è¯•ï¼‰
 */
export async function mockPayment(orderNo: string): Promise<boolean> {
  // æ¨¡æ‹Ÿæ”¯ä»˜å»¶è¿Ÿ
  await new Promise(resolve => setTimeout(resolve, 2000))

  // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸï¼ˆ90%æˆåŠŸç‡ï¼‰
  const success = Math.random() > 0.1

  if (success) {
    // è¿™é‡Œåº”è¯¥è°ƒç”¨åç«¯æ¥å£æ›´æ–°è®¢å•çŠ¶æ€
    // å®é™…é¡¹ç›®ä¸­ï¼Œè¿™ä¸ªæ“ä½œåº”è¯¥åœ¨åç«¯å®Œæˆ
    console.log('æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ:', orderNo)
    return true
  } else {
    throw new Error('æ¨¡æ‹Ÿæ”¯ä»˜å¤±è´¥')
  }
}
```

#### 2. åˆ›å»ºStripeæ”¯ä»˜ç»„ä»¶

```typescript
// src/components/payment/StripePayment.tsx

import { useState } from 'react'
import { loadStripe } from '@stripe/stripe-js'
import {
  Elements,
  PaymentElement,
  useStripe,
  useElements,
} from '@stripe/react-stripe-js'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Loader2 } from 'lucide-react'
import { toast } from 'sonner'

// åŠ è½½Stripe
const stripePromise = loadStripe(import.meta.env.VITE_STRIPE_PUBLISHABLE_KEY)

interface StripePaymentFormProps {
  clientSecret: string
  amount: number
  currency: string
  onSuccess: () => void
  onError: (error: string) => void
}

function StripePaymentForm({ clientSecret, amount, currency, onSuccess, onError }: StripePaymentFormProps) {
  const stripe = useStripe()
  const elements = useElements()
  const [loading, setLoading] = useState(false)

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    if (!stripe || !elements) {
      return
    }

    setLoading(true)

    try {
      const { error, paymentIntent } = await stripe.confirmPayment({
        elements,
        confirmParams: {
          return_url: `${window.location.origin}/payment/success`,
        },
        redirect: 'if_required',
      })

      if (error) {
        onError(error.message || 'æ”¯ä»˜å¤±è´¥')
        toast.error(error.message || 'æ”¯ä»˜å¤±è´¥')
      } else if (paymentIntent && paymentIntent.status === 'succeeded') {
        onSuccess()
        toast.success('æ”¯ä»˜æˆåŠŸï¼')
      }
    } catch (err: any) {
      onError(err.message)
      toast.error(err.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <div className="space-y-2">
        <div className="text-sm text-muted-foreground">
          æ”¯ä»˜é‡‘é¢ï¼š
          <span className="text-2xl font-bold text-foreground ml-2">
            {currency === 'CNY' ? 'Â¥' : '$'}
            {amount.toFixed(2)}
          </span>
        </div>
      </div>

      <PaymentElement />

      <Button
        type="submit"
        disabled={!stripe || loading}
        className="w-full"
        size="lg"
      >
        {loading ? (
          <>
            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
            å¤„ç†ä¸­...
          </>
        ) : (
          `æ”¯ä»˜ ${currency === 'CNY' ? 'Â¥' : '$'}${amount.toFixed(2)}`
        )}
      </Button>
    </form>
  )
}

interface StripePaymentProps {
  clientSecret: string
  amount: number
  currency: string
  subject: string
  onSuccess: () => void
  onError: (error: string) => void
}

export default function StripePayment({
  clientSecret,
  amount,
  currency,
  subject,
  onSuccess,
  onError,
}: StripePaymentProps) {
  const options = {
    clientSecret,
    appearance: {
      theme: 'stripe' as const,
    },
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>å®Œæˆæ”¯ä»˜</CardTitle>
        <CardDescription>{subject}</CardDescription>
      </CardHeader>
      <CardContent>
        <Elements stripe={stripePromise} options={options}>
          <StripePaymentForm
            clientSecret={clientSecret}
            amount={amount}
            currency={currency}
            onSuccess={onSuccess}
            onError={onError}
          />
        </Elements>
      </CardContent>
    </Card>
  )
}
```

#### 3. åˆ›å»ºæ¨¡æ‹Ÿæ”¯ä»˜ç»„ä»¶

```typescript
// src/components/payment/MockPayment.tsx

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Loader2, CreditCard } from 'lucide-react'
import { toast } from 'sonner'
import { mockPayment } from '@/lib/payment'

interface MockPaymentProps {
  orderNo: string
  amount: number
  currency: string
  subject: string
  onSuccess: () => void
  onError: (error: string) => void
}

export default function MockPayment({
  orderNo,
  amount,
  currency,
  subject,
  onSuccess,
  onError,
}: MockPaymentProps) {
  const [loading, setLoading] = useState(false)
  const [password, setPassword] = useState('')

  const handlePay = async () => {
    if (!password) {
      toast.error('è¯·è¾“å…¥æ”¯ä»˜å¯†ç ')
      return
    }

    setLoading(true)

    try {
      // æ¨¡æ‹Ÿæ”¯ä»˜
      await mockPayment(orderNo)
      toast.success('æ”¯ä»˜æˆåŠŸï¼')
      onSuccess()
    } catch (err: any) {
      toast.error(err.message || 'æ”¯ä»˜å¤±è´¥')
      onError(err.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <CreditCard className="h-5 w-5" />
          æ¨¡æ‹Ÿæ”¯ä»˜
        </CardTitle>
        <CardDescription>{subject}</CardDescription>
      </CardHeader>
      <CardContent className="space-y-6">
        <div className="space-y-2">
          <div className="text-sm text-muted-foreground">
            æ”¯ä»˜é‡‘é¢ï¼š
            <span className="text-2xl font-bold text-foreground ml-2">
              {currency === 'CNY' ? 'Â¥' : '$'}
              {amount.toFixed(2)}
            </span>
          </div>
        </div>

        <div className="space-y-2">
          <Label htmlFor="password">æ”¯ä»˜å¯†ç </Label>
          <Input
            id="password"
            type="password"
            placeholder="è¾“å…¥ä»»æ„6ä½æ•°å­—"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            maxLength={6}
          />
          <p className="text-xs text-muted-foreground">
            è¿™æ˜¯æ¨¡æ‹Ÿæ”¯ä»˜ï¼Œè¾“å…¥ä»»æ„6ä½æ•°å­—å³å¯
          </p>
        </div>

        <div className="bg-muted p-4 rounded-lg space-y-2 text-sm">
          <p className="font-semibold">ğŸ’¡ æ¨¡æ‹Ÿæ”¯ä»˜è¯´æ˜ï¼š</p>
          <ul className="list-disc list-inside space-y-1 text-muted-foreground">
            <li>è¿™æ˜¯å¼€å‘æµ‹è¯•ç”¨çš„æ¨¡æ‹Ÿæ”¯ä»˜</li>
            <li>è¾“å…¥ä»»æ„6ä½æ•°å­—ä½œä¸ºå¯†ç </li>
            <li>90%æ¦‚ç‡æ”¯ä»˜æˆåŠŸï¼Œ10%æ¦‚ç‡å¤±è´¥</li>
            <li>ä¸ä¼šäº§ç”ŸçœŸå®æ‰£æ¬¾</li>
          </ul>
        </div>

        <Button
          onClick={handlePay}
          disabled={loading || password.length !== 6}
          className="w-full"
          size="lg"
        >
          {loading ? (
            <>
              <Loader2 className="mr-2 h-4 w-4 animate-spin" />
              å¤„ç†ä¸­...
            </>
          ) : (
            `ç¡®è®¤æ”¯ä»˜ ${currency === 'CNY' ? 'Â¥' : '$'}${amount.toFixed(2)}`
          )}
        </Button>
      </CardContent>
    </Card>
  )
}
```

#### 4. åˆ›å»ºæ”¯ä»˜é¡µé¢

```typescript
// src/pages/Payment.tsx

import { useState, useEffect } from 'react'
import { useSearchParams, useNavigate } from 'react-router-dom'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Loader2, CheckCircle2, XCircle, ArrowLeft } from 'lucide-react'
import { toast } from 'sonner'
import { createPayment, queryPaymentStatus } from '@/lib/payment'
import StripePayment from '@/components/payment/StripePayment'
import MockPayment from '@/components/payment/MockPayment'

export default function Payment() {
  const [searchParams] = useSearchParams()
  const navigate = useNavigate()

  // ä»URLè·å–æ”¯ä»˜å‚æ•°
  const amount = Number.parseFloat(searchParams.get('amount') || '0')
  const subject = searchParams.get('subject') || 'è®¢å•æ”¯ä»˜'
  const businessType = searchParams.get('type') || 'membership'
  const businessId = searchParams.get('id') || undefined

  const [loading, setLoading] = useState(false)
  const [paymentMethod, setPaymentMethod] = useState<'stripe' | 'mock'>('mock')
  const [orderData, setOrderData] = useState<any>(null)
  const [paymentStatus, setPaymentStatus] = useState<'pending' | 'success' | 'failed'>('pending')

  // åˆ›å»ºæ”¯ä»˜è®¢å•
  const handleCreatePayment = async (method: 'stripe' | 'mock') => {
    setLoading(true)
    setPaymentMethod(method)

    try {
      const order = await createPayment({
        amount,
        currency: 'CNY',
        subject,
        description: `${subject} - ${amount}å…ƒ`,
        businessType,
        businessId,
        paymentMethod: method,
      })

      setOrderData(order)
      toast.success('è®¢å•åˆ›å»ºæˆåŠŸ')
    } catch (err: any) {
      toast.error(err.message || 'åˆ›å»ºè®¢å•å¤±è´¥')
    } finally {
      setLoading(false)
    }
  }

  // æ”¯ä»˜æˆåŠŸå›è°ƒ
  const handlePaymentSuccess = async () => {
    setPaymentStatus('success')

    // ç­‰å¾…ä¸€ä¸‹ï¼Œè®©å›è°ƒå¤„ç†å®Œæˆ
    await new Promise(resolve => setTimeout(resolve, 2000))

    // æŸ¥è¯¢æœ€ç»ˆçŠ¶æ€
    if (orderData) {
      try {
        const status = await queryPaymentStatus(orderData.order_no)
        if (status.payment_status === 'paid') {
          toast.success('æ”¯ä»˜æˆåŠŸï¼')
          setTimeout(() => {
            navigate('/')
          }, 2000)
        }
      } catch (err) {
        console.error('æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€å¤±è´¥:', err)
      }
    }
  }

  // æ”¯ä»˜å¤±è´¥å›è°ƒ
  const handlePaymentError = (error: string) => {
    setPaymentStatus('failed')
    toast.error(error)
  }

  // å¦‚æœæ²¡æœ‰é‡‘é¢ï¼Œè¿”å›é¦–é¡µ
  if (!amount || amount <= 0) {
    return (
      <div className="min-h-screen flex items-center justify-center p-4">
        <Card className="max-w-md w-full">
          <CardHeader>
            <CardTitle>å‚æ•°é”™è¯¯</CardTitle>
            <CardDescription>ç¼ºå°‘æ”¯ä»˜é‡‘é¢</CardDescription>
          </CardHeader>
          <CardContent>
            <Button onClick={() => navigate('/')} className="w-full">
              è¿”å›é¦–é¡µ
            </Button>
          </CardContent>
        </Card>
      </div>
    )
  }

  // æ”¯ä»˜æˆåŠŸé¡µé¢
  if (paymentStatus === 'success') {
    return (
      <div className="min-h-screen flex items-center justify-center p-4">
        <Card className="max-w-md w-full">
          <CardHeader>
            <div className="flex flex-col items-center gap-4">
              <CheckCircle2 className="h-16 w-16 text-green-500" />
              <CardTitle>æ”¯ä»˜æˆåŠŸï¼</CardTitle>
              <CardDescription>æ‚¨çš„æ”¯ä»˜å·²å®Œæˆ</CardDescription>
            </div>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="bg-muted p-4 rounded-lg space-y-2">
              <div className="flex justify-between">
                <span className="text-muted-foreground">è®¢å•å·ï¼š</span>
                <span className="font-mono">{orderData?.order_no}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">æ”¯ä»˜é‡‘é¢ï¼š</span>
                <span className="font-bold">Â¥{amount.toFixed(2)}</span>
              </div>
            </div>
            <Button onClick={() => navigate('/')} className="w-full">
              è¿”å›é¦–é¡µ
            </Button>
          </CardContent>
        </Card>
      </div>
    )
  }

  // æ”¯ä»˜å¤±è´¥é¡µé¢
  if (paymentStatus === 'failed') {
    return (
      <div className="min-h-screen flex items-center justify-center p-4">
        <Card className="max-w-md w-full">
          <CardHeader>
            <div className="flex flex-col items-center gap-4">
              <XCircle className="h-16 w-16 text-red-500" />
              <CardTitle>æ”¯ä»˜å¤±è´¥</CardTitle>
              <CardDescription>è¯·é‡è¯•æˆ–è”ç³»å®¢æœ</CardDescription>
            </div>
          </CardHeader>
          <CardContent className="space-y-4">
            <Button onClick={() => setPaymentStatus('pending')} className="w-full">
              é‡æ–°æ”¯ä»˜
            </Button>
            <Button onClick={() => navigate('/')} variant="outline" className="w-full">
              è¿”å›é¦–é¡µ
            </Button>
          </CardContent>
        </Card>
      </div>
    )
  }

  // æ”¯ä»˜é¡µé¢
  return (
    <div className="min-h-screen bg-muted/30 p-4">
      <div className="max-w-2xl mx-auto space-y-4">
        {/* è¿”å›æŒ‰é’® */}
        <Button
          variant="ghost"
          onClick={() => navigate(-1)}
          className="gap-2"
        >
          <ArrowLeft className="h-4 w-4" />
          è¿”å›
        </Button>

        {/* è®¢å•ä¿¡æ¯ */}
        <Card>
          <CardHeader>
            <CardTitle>è®¢å•ä¿¡æ¯</CardTitle>
          </CardHeader>
          <CardContent className="space-y-2">
            <div className="flex justify-between">
              <span className="text-muted-foreground">å•†å“åç§°ï¼š</span>
              <span>{subject}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-muted-foreground">æ”¯ä»˜é‡‘é¢ï¼š</span>
              <span className="text-2xl font-bold text-primary">Â¥{amount.toFixed(2)}</span>
            </div>
          </CardContent>
        </Card>

        {/* æ”¯ä»˜æ–¹å¼é€‰æ‹© */}
        {!orderData && (
          <Card>
            <CardHeader>
              <CardTitle>é€‰æ‹©æ”¯ä»˜æ–¹å¼</CardTitle>
              <CardDescription>è¯·é€‰æ‹©æ‚¨çš„æ”¯ä»˜æ–¹å¼</CardDescription>
            </CardHeader>
            <CardContent>
              <Tabs defaultValue="mock" className="w-full">
                <TabsList className="grid w-full grid-cols-2">
                  <TabsTrigger value="mock">æ¨¡æ‹Ÿæ”¯ä»˜</TabsTrigger>
                  <TabsTrigger value="stripe">Stripeæ”¯ä»˜</TabsTrigger>
                </TabsList>

                <TabsContent value="mock" className="space-y-4">
                  <div className="bg-muted p-4 rounded-lg space-y-2 text-sm">
                    <p className="font-semibold">ğŸ’¡ æ¨¡æ‹Ÿæ”¯ä»˜</p>
                    <p className="text-muted-foreground">
                      ç”¨äºå¼€å‘æµ‹è¯•ï¼Œä¸ä¼šäº§ç”ŸçœŸå®æ‰£æ¬¾
                    </p>
                  </div>
                  <Button
                    onClick={() => handleCreatePayment('mock')}
                    disabled={loading}
                    className="w-full"
                    size="lg"
                  >
                    {loading ? (
                      <>
                        <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                        åˆ›å»ºè®¢å•ä¸­...
                      </>
                    ) : (
                      'ä½¿ç”¨æ¨¡æ‹Ÿæ”¯ä»˜'
                    )}
                  </Button>
                </TabsContent>

                <TabsContent value="stripe" className="space-y-4">
                  <div className="bg-muted p-4 rounded-lg space-y-2 text-sm">
                    <p className="font-semibold">ğŸ’³ Stripeæ”¯ä»˜</p>
                    <p className="text-muted-foreground">
                      æ”¯æŒä¿¡ç”¨å¡ã€å€Ÿè®°å¡ç­‰å¤šç§æ”¯ä»˜æ–¹å¼
                    </p>
                  </div>
                  <Button
                    onClick={() => handleCreatePayment('stripe')}
                    disabled={loading}
                    className="w-full"
                    size="lg"
                  >
                    {loading ? (
                      <>
                        <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                        åˆ›å»ºè®¢å•ä¸­...
                      </>
                    ) : (
                      'ä½¿ç”¨Stripeæ”¯ä»˜'
                    )}
                  </Button>
                </TabsContent>
              </Tabs>
            </CardContent>
          </Card>
        )}

        {/* æ”¯ä»˜ç»„ä»¶ */}
        {orderData && (
          <div>
            {paymentMethod === 'stripe' && orderData.payment_data.client_secret && (
              <StripePayment
                clientSecret={orderData.payment_data.client_secret}
                amount={amount}
                currency="CNY"
                subject={subject}
                onSuccess={handlePaymentSuccess}
                onError={handlePaymentError}
              />
            )}

            {paymentMethod === 'mock' && (
              <MockPayment
                orderNo={orderData.order_no}
                amount={amount}
                currency="CNY"
                subject={subject}
                onSuccess={handlePaymentSuccess}
                onError={handlePaymentError}
              />
            )}
          </div>
        )}
      </div>
    </div>
  )
}
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. æ¨¡æ‹Ÿæ”¯ä»˜æµ‹è¯•

```bash
# 1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# 2. è®¿é—®æ”¯ä»˜é¡µé¢
http://localhost:5173/payment?amount=99.00&subject=ä¼šå‘˜å……å€¼&type=membership

# 3. é€‰æ‹©"æ¨¡æ‹Ÿæ”¯ä»˜"
# 4. è¾“å…¥ä»»æ„6ä½æ•°å­—ä½œä¸ºå¯†ç 
# 5. ç‚¹å‡»"ç¡®è®¤æ”¯ä»˜"
# 6. æŸ¥çœ‹æ”¯ä»˜ç»“æœ
```

### 2. Stripeæµ‹è¯•æ”¯ä»˜

```bash
# 1. æ³¨å†ŒStripeæµ‹è¯•è´¦å·
https://dashboard.stripe.com/register

# 2. è·å–æµ‹è¯•å¯†é’¥
# è¿›å…¥Dashboard > Developers > API keys
# å¤åˆ¶Publishable keyå’ŒSecret key

# 3. é…ç½®ç¯å¢ƒå˜é‡
# .envæ–‡ä»¶ä¸­æ·»åŠ ï¼š
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_xxxxx
STRIPE_SECRET_KEY=sk_test_xxxxx

# 4. éƒ¨ç½²Edge Functions
supabase functions deploy create-payment
supabase functions deploy payment-callback
supabase functions deploy query-payment

# 5. é…ç½®Stripe Webhook
# Dashboard > Developers > Webhooks
# æ·»åŠ endpoint: https://your-project.supabase.co/functions/v1/payment-callback
# é€‰æ‹©äº‹ä»¶: payment_intent.succeeded

# 6. æµ‹è¯•æ”¯ä»˜
# è®¿é—®æ”¯ä»˜é¡µé¢ï¼Œé€‰æ‹©"Stripeæ”¯ä»˜"
# ä½¿ç”¨æµ‹è¯•å¡å·ï¼š4242 4242 4242 4242
# è¿‡æœŸæ—¥æœŸï¼šä»»æ„æœªæ¥æ—¥æœŸ
# CVCï¼šä»»æ„3ä½æ•°å­—
# é‚®ç¼–ï¼šä»»æ„5ä½æ•°å­—
```

### 3. æµ‹è¯•å¡å·

Stripeæä¾›çš„æµ‹è¯•å¡å·ï¼š

```
æˆåŠŸæ”¯ä»˜ï¼š
4242 4242 4242 4242  (Visa)
5555 5555 5555 4444  (Mastercard)

éœ€è¦3DéªŒè¯ï¼š
4000 0027 6000 3184

æ”¯ä»˜å¤±è´¥ï¼š
4000 0000 0000 0002  (å¡è¢«æ‹’ç»)
4000 0000 0000 9995  (ä½™é¢ä¸è¶³)
```

---

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. å¯†é’¥ç®¡ç†

```bash
# âŒ é”™è¯¯ï¼šå¯†é’¥å†™åœ¨ä»£ç é‡Œ
const apiKey = 'sk_live_xxxxx'

# âœ… æ­£ç¡®ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡
const apiKey = process.env.STRIPE_SECRET_KEY
```

### 2. é‡‘é¢éªŒè¯

```typescript
// âŒ é”™è¯¯ï¼šä¿¡ä»»å‰ç«¯ä¼ æ¥çš„é‡‘é¢
app.post('/create-payment', (req, res) => {
  const { amount } = req.body  // å±é™©ï¼ç”¨æˆ·å¯ä»¥ä¿®æ”¹
  // ...
})

// âœ… æ­£ç¡®ï¼šåç«¯è®¡ç®—é‡‘é¢
app.post('/create-payment', (req, res) => {
  const { productId } = req.body
  const product = getProduct(productId)
  const amount = product.price  // ä»æ•°æ®åº“è·å–
  // ...
})
```

### 3. ç­¾åéªŒè¯

```typescript
// âœ… å¿…é¡»éªŒè¯å›è°ƒç­¾å
const event = stripe.webhooks.constructEvent(
  body,
  signature,
  webhookSecret
)
```

### 4. å¹‚ç­‰æ€§å¤„ç†

```typescript
// âœ… é˜²æ­¢é‡å¤å¤„ç†
const { data: existing } = await supabase
  .from('payment_orders')
  .select('*')
  .eq('transaction_id', paymentIntent.id)
  .single()

if (existing && existing.payment_status === 'paid') {
  // å·²ç»å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›
  return
}
```

### 5. HTTPSè¦æ±‚

```bash
# âŒ é”™è¯¯ï¼šä½¿ç”¨HTTP
http://your-domain.com/payment

# âœ… æ­£ç¡®ï¼šä½¿ç”¨HTTPS
https://your-domain.com/payment
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•ç”³è¯·å¾®ä¿¡/æ”¯ä»˜å®å•†æˆ·å·ï¼Ÿ

**A:** éœ€è¦ä»¥ä¸‹ææ–™ï¼š
1. è¥ä¸šæ‰§ç…§
2. æ³•äººèº«ä»½è¯
3. é“¶è¡Œå¼€æˆ·è®¸å¯è¯
4. ç»è¥åœºæ‰€ç…§ç‰‡
5. ç”³è¯·æµç¨‹ï¼š
   - å¾®ä¿¡æ”¯ä»˜ï¼šhttps://pay.weixin.qq.com/
   - æ”¯ä»˜å®ï¼šhttps://open.alipay.com/

### Q2: æ”¯ä»˜å›è°ƒæ²¡æœ‰æ”¶åˆ°æ€ä¹ˆåŠï¼Ÿ

**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. å›è°ƒURLæ˜¯å¦å…¬ç½‘å¯è®¿é—®
2. æ˜¯å¦ä½¿ç”¨HTTPS
3. æ˜¯å¦æ­£ç¡®é…ç½®äº†Webhook
4. æŸ¥çœ‹æ”¯ä»˜å¹³å°çš„Webhookæ—¥å¿—
5. æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™è®¾ç½®

### Q3: å¦‚ä½•æµ‹è¯•æ”¯ä»˜å›è°ƒï¼Ÿ

**A:** ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š
1. ä½¿ç”¨ngrokç­‰å·¥å…·æš´éœ²æœ¬åœ°æœåŠ¡
2. ä½¿ç”¨Stripe CLIæµ‹è¯•Webhook
3. ä½¿ç”¨Postmanæ¨¡æ‹Ÿå›è°ƒè¯·æ±‚
4. æŸ¥çœ‹æ”¯ä»˜å¹³å°çš„æµ‹è¯•å·¥å…·

### Q4: æ”¯ä»˜é‡‘é¢å•ä½æ˜¯ä»€ä¹ˆï¼Ÿ

**A:** ä¸åŒå¹³å°ä¸åŒï¼š
- Stripeï¼šåˆ†ï¼ˆcentsï¼‰ï¼Œéœ€è¦ä¹˜ä»¥100
- å¾®ä¿¡/æ”¯ä»˜å®ï¼šåˆ†ï¼Œéœ€è¦ä¹˜ä»¥100
- PayPalï¼šå…ƒï¼ˆdollarsï¼‰

### Q5: å¦‚ä½•å¤„ç†é€€æ¬¾ï¼Ÿ

**A:** è°ƒç”¨é€€æ¬¾APIï¼š
```typescript
const refund = await stripe.refunds.create({
  payment_intent: paymentIntentId,
  amount: refundAmount,  // å¯ä»¥éƒ¨åˆ†é€€æ¬¾
})
```

### Q6: ç”Ÿäº§ç¯å¢ƒéœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ

**A:** 
1. ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒå¯†é’¥
2. é…ç½®æ­£ç¡®çš„å›è°ƒURL
3. å¯ç”¨æ—¥å¿—è®°å½•
4. è®¾ç½®å‘Šè­¦ç›‘æ§
5. å®šæœŸå¯¹è´¦
6. å¤‡ä»½æ”¯ä»˜æ•°æ®

---

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- **Stripe**: https://stripe.com/docs
- **å¾®ä¿¡æ”¯ä»˜**: https://pay.weixin.qq.com/wiki/doc/api/index.html
- **æ”¯ä»˜å®**: https://open.alipay.com/docs/
- **PayPal**: https://developer.paypal.com/

### æ¨èé˜…è¯»

- ã€Šæ”¯ä»˜ç³»ç»Ÿè®¾è®¡ä¸å®ç°ã€‹
- ã€Šäº’è”ç½‘æ”¯ä»˜å®‰å…¨ã€‹
- Stripeå®˜æ–¹åšå®¢
- æ”¯ä»˜å®æŠ€æœ¯åšå®¢

---

## ğŸ“ å­¦ä¹ è·¯å¾„

### åˆçº§ï¼ˆ1-2å‘¨ï¼‰

1. ç†è§£æ”¯ä»˜æµç¨‹
2. å­¦ä¹ StripeåŸºç¡€API
3. å®ç°æ¨¡æ‹Ÿæ”¯ä»˜
4. å®Œæˆç®€å•çš„æ”¯ä»˜é¡µé¢

### ä¸­çº§ï¼ˆ2-4å‘¨ï¼‰

1. å®ç°çœŸå®æ”¯ä»˜
2. å¤„ç†æ”¯ä»˜å›è°ƒ
3. å®ç°è®¢å•ç®¡ç†
4. æ·»åŠ é€€æ¬¾åŠŸèƒ½

### é«˜çº§ï¼ˆ1-2æœˆï¼‰

1. æ¥å…¥å¾®ä¿¡/æ”¯ä»˜å®
2. å®ç°åˆ†è´¦åŠŸèƒ½
3. å¯¹è´¦ç³»ç»Ÿ
4. é£æ§ç³»ç»Ÿ

---

## ğŸ‰ æ€»ç»“

é€šè¿‡æœ¬æ•™ç¨‹ï¼Œæ‚¨å·²ç»å­¦ä¼šäº†ï¼š

1. âœ… æ”¯ä»˜çš„åŸºæœ¬åŸç†å’Œæµç¨‹
2. âœ… å¦‚ä½•åˆ›å»ºæ”¯ä»˜è®¢å•
3. âœ… å¦‚ä½•å¤„ç†æ”¯ä»˜å›è°ƒ
4. âœ… å¦‚ä½•å®ç°å‰ç«¯æ”¯ä»˜ç•Œé¢
5. âœ… å¦‚ä½•æµ‹è¯•æ”¯ä»˜åŠŸèƒ½
6. âœ… æ”¯ä»˜å®‰å…¨çš„æ³¨æ„äº‹é¡¹

**ä¸‹ä¸€æ­¥å»ºè®®ï¼š**

1. å®è·µæ¨¡æ‹Ÿæ”¯ä»˜
2. æ³¨å†ŒStripeæµ‹è¯•è´¦å·
3. å®ŒæˆçœŸå®æ”¯ä»˜æµ‹è¯•
4. å­¦ä¹ å¾®ä¿¡/æ”¯ä»˜å®æ¥å…¥
5. å®ç°å®Œæ•´çš„æ”¯ä»˜ç³»ç»Ÿ

**ç¥æ‚¨å­¦ä¹ æ„‰å¿«ï¼** ğŸŠ

å¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿éšæ—¶å’¨è¯¢ï¼
