# 会员制系统功能说明

## 📋 功能概述

二手车销售管理系统已升级为会员制SaaS平台，车商入驻后需要根据在售车辆数量选择相应的会员等级并支付年费。

## 🎯 会员等级规则

### 免费期
- **时长**：入驻后6个月
- **权益**：免费使用所有功能
- **说明**：从车商审核通过之日起计算

### 会员等级

| 会员等级 | 在售车辆数量 | 年费 | 说明 |
|---------|------------|------|------|
| 三级会员 | 0-20台 | ¥198/年 | 适合小型车行 |
| 二级会员 | 21-50台 | ¥365/年 | 适合中型车行 |
| 一级会员 | 51-150台 | ¥580/年 | 适合大型车行 |
| 金牌会员 | 151台以上 | ¥980/年 | 适合超大型车行 |

## 🔄 自动等级判定

系统会根据车商的**在售车辆数量**自动判定会员等级：

### 触发时机
- 车辆入库（状态为"在售"）
- 车辆销售（状态从"在售"变为"已售"）
- 车辆状态变更

### 判定规则
- **升级**：车辆数量增加导致等级提升时，立即生效
- **降级**：车辆数量减少导致等级降低时，在下次续费时生效
- **实时更新**：系统通过数据库触发器自动更新会员等级

## 💳 会员功能

### 1. 会员中心页面

**访问路径**：系统菜单 → 会员中心

**功能包括**：
- 查看当前会员等级
- 查看在售车辆数量
- 查看会员到期时间
- 查看免费期剩余时间（如果在免费期内）
- 会员等级说明
- 支付历史记录
- 会员权益说明

### 2. 会员状态提醒

**免费期提醒**：
- 免费期剩余30天内显示提醒
- 提示用户及时续费

**会员到期提醒**：
- 会员到期前30天显示提醒
- 引导用户续费

**等级变化提示**：
- 当前车辆数量对应的等级与实际等级不符时显示提示
- 建议用户升级或降级

### 3. 续费功能

**当前状态**：功能开发中，请联系客服续费

**未来功能**：
- 在线选择会员等级
- 在线支付
- 自动续费
- 发票开具

## 🔧 技术实现

### 数据库表结构

#### 1. membership_tiers（会员等级表）
- 存储所有会员等级信息
- 包含等级名称、车辆数量范围、年费等

#### 2. dealership_memberships（会员订阅表）
- 存储车商的会员信息
- 包含会员等级、开始日期、结束日期、免费期等

#### 3. membership_payments（支付记录表）
- 存储会员支付记录
- 包含支付金额、支付状态、支付时间等

### 自动化功能

#### 1. 数据库触发器
```sql
-- 车辆状态变更时自动更新会员等级
CREATE TRIGGER update_membership_on_vehicle_change
  AFTER INSERT OR UPDATE OR DELETE ON vehicles
  FOR EACH ROW
  EXECUTE FUNCTION trigger_update_membership_on_vehicle_change();
```

#### 2. 数据库函数
- `calculate_membership_tier(vehicle_count)` - 根据车辆数量计算会员等级
- `get_dealership_vehicle_count(dealership_id)` - 获取车商在售车辆数量
- `initialize_dealership_membership(dealership_id)` - 初始化车商会员
- `update_dealership_membership_tier(dealership_id)` - 更新车商会员等级

### API接口

#### 会员管理API（src/db/membershipApi.ts）
- `getMembershipTiers()` - 获取所有会员等级
- `getCurrentMembership(dealershipId)` - 获取当前会员信息
- `checkMembershipStatus(dealershipId)` - 检查会员状态
- `renewMembership(dealershipId, tierId)` - 续费会员
- `getPaymentHistory(dealershipId)` - 获取支付历史

## 📱 用户使用流程

### 新车商入驻
1. 注册账号并提交车行信息
2. 等待平台管理员审核
3. 审核通过后，系统自动初始化会员（6个月免费期）
4. 开始使用系统功能

### 免费期内
1. 正常使用所有功能
2. 系统根据在售车辆数量自动判定会员等级
3. 免费期剩余30天时收到提醒

### 免费期结束
1. 收到续费提醒
2. 联系客服进行续费（未来支持在线续费）
3. 续费后继续使用系统

### 会员期内
1. 正常使用所有功能
2. 车辆数量变化时，系统自动更新会员等级
3. 会员到期前30天收到提醒
4. 及时续费以继续使用服务

## 🔐 权限控制

### 会员中心访问权限
- **管理员**：可以访问会员中心，查看和管理会员信息
- **员工**：无法访问会员中心

### 会员状态检查
- 系统会检查车商的会员状态
- 会员到期后，可能会限制部分功能（待实现）

## 📊 管理员功能

### 平台管理员（super_admin）

**查看所有车商会员信息**：
- 访问数据库可以查看所有车商的会员状态
- 查看会员等级分布
- 查看支付记录

**手动调整会员信息**：
- 可以手动修改会员等级
- 可以手动延长会员期限
- 可以手动更新支付状态

## 🎨 界面展示

### 会员中心页面

#### 1. 当前会员状态卡片
- 显示会员等级（带颜色徽章）
- 显示在售车辆数量
- 显示会员剩余天数
- 显示会员状态（免费期/正常/已到期）

#### 2. 会员等级说明卡片
- 展示所有会员等级
- 显示每个等级的价格和车辆数量范围
- 高亮显示当前等级

#### 3. 续费卡片
- 提供续费入口
- 显示续费说明

#### 4. 支付历史卡片
- 显示所有支付记录
- 显示支付状态和金额

#### 5. 会员权益说明卡片
- 列出所有会员权益
- 说明会员可以使用的功能

#### 6. 免费期说明卡片
- 说明免费期规则
- 提示用户及时续费

## 🚀 未来功能规划

### Phase 2: 完善功能
- [ ] 在线续费功能
- [ ] 支付接口集成（微信支付、支付宝）
- [ ] 自动续费功能
- [ ] 发票开具功能
- [ ] 会员到期邮件/短信提醒

### Phase 3: 增强功能
- [ ] 不同等级会员的权益差异化
- [ ] 会员统计分析
- [ ] 会员营销功能
- [ ] 会员推荐奖励
- [ ] 会员优惠活动

## 📝 注意事项

### 1. 免费期计算
- 从车商审核通过日期开始计算6个月
- 免费期内不收取任何费用
- 免费期结束后需要续费才能继续使用

### 2. 等级判定
- 基于**在售车辆数量**，不包括已售车辆
- 实时更新，车辆状态变更时自动判定
- 升级立即生效，降级在下次续费时生效

### 3. 续费逻辑
- 续费时按当前车辆数量对应的等级收费
- 续费后会员期限延长1年
- 支持提前续费

### 4. 数据安全
- 所有会员数据存储在Supabase数据库
- 使用RLS（行级安全）策略保护数据
- 车商只能查看自己的会员信息
- 平台管理员可以查看所有会员信息

## 🔍 测试建议

### 1. 会员初始化测试
- 创建新车商并审核通过
- 检查是否自动创建会员记录
- 检查免费期是否正确设置为6个月

### 2. 等级判定测试
- 添加不同数量的在售车辆
- 检查会员等级是否自动更新
- 测试边界值（20台、50台、150台）

### 3. 会员中心测试
- 访问会员中心页面
- 检查所有信息是否正确显示
- 测试不同会员状态的显示

### 4. 权限测试
- 使用管理员账号访问会员中心
- 使用员工账号尝试访问会员中心（应该无法访问）

## 📞 技术支持

如有任何问题，请联系技术支持团队。

---

**文档版本**：v1.0  
**最后更新**：2026-01-10  
**适用系统**：二手车销售管理系统 v2.0+
