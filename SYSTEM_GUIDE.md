# 二手车销售管理系统 - 系统说明

## 系统概述

这是一个完整的二手车销售管理系统，采用现代化的技术栈构建，提供了从车辆入库、销售管理到利润分配的全流程管理功能。

## 技术栈

- **前端框架**: React 18 + TypeScript
- **UI 组件库**: shadcn/ui + Tailwind CSS
- **路由管理**: React Router v6
- **状态管理**: React Context + Hooks
- **数据库**: Supabase (PostgreSQL)
- **认证系统**: Supabase Auth
- **文件存储**: Supabase Storage
- **图片压缩**: browser-image-compression
- **构建工具**: Vite

## 核心功能

### 1. 认证系统
- ✅ 用户注册/登录（用户名+密码）
- ✅ 首个注册用户自动成为管理员
- ✅ 基于角色的权限控制（管理员/员工）
- ✅ 路由守卫保护

### 2. 员工管理
- ✅ 员工信息管理（姓名、职位、联系方式、入职日期）
- ✅ 多角色分配系统：
  - 地租（18%）
  - 月奖金池（10%）
  - 销售提成（36%）
  - 押车出资人（36%）
- ✅ 支持一人多角色、多人一角色
- ✅ 角色分配比例自定义

### 3. 车辆管理
- ✅ 车辆入库（车架号后六位作为唯一标识）
- ✅ 车辆信息录入（品牌、型号、年份、里程、车况等）
- ✅ 车辆照片上传（支持多张，自动压缩至1MB以下）
- ✅ 成本记录（购车款、整备费、过户费、杂费）
- ✅ 车辆状态管理（在售/已售）

### 4. 销售管理
- ✅ 销售记录（基础版）
- 🚧 销售信息录入（待完善）
- 🚧 贷款返利记录（待完善）
- 🚧 利润自动计算（待完善）

### 5. 费用管理
- ✅ 费用记录（基础版）
- 🚧 费用分类管理（待完善）
- 🚧 月度费用统计（待完善）

### 6. 利润分配
- ✅ 利润分配记录（基础版）
- 🚧 自动利润分配计算（待完善）
- 🚧 月度奖金池管理（待完善）
- 🚧 销售冠军奖金（待完善）

### 7. 统计分析
- ✅ 仪表盘概览
- 🚧 月度销售统计（待完善）
- 🚧 员工业绩排行（待完善）
- 🚧 销售趋势图表（待完善）

### 8. 手机端展示
- ✅ 客户端车辆展示（无需登录）
- ✅ 车辆列表展示
- 🚧 内部通报系统（待完善）

### 9. 管理员功能
- ✅ 用户管理
- ✅ 角色权限设置

## 数据库结构

### 核心表
1. **profiles** - 用户资料表
2. **employees** - 员工信息表
3. **employee_roles** - 员工角色关联表
4. **vehicles** - 车辆信息表
5. **vehicle_costs** - 车辆成本明细表
6. **vehicle_sales** - 车辆销售记录表
7. **expenses** - 费用记录表
8. **profit_distributions** - 利润分配记录表
9. **monthly_bonuses** - 月度奖金池表

### 存储桶
- **app_8u0242wc45c1_vehicle_images** - 车辆图片存储（1MB限制）

## 使用指南

### 首次使用

1. **注册管理员账号**
   - 访问系统登录页面
   - 点击"注册"标签
   - 输入用户名和密码（至少6位）
   - 第一个注册的用户自动成为管理员

2. **添加员工**
   - 登录后进入"员工管理"页面
   - 点击"添加员工"按钮
   - 填写员工信息
   - 为员工分配角色和分配比例

3. **车辆入库**
   - 进入"车辆管理"页面
   - 点击"车辆入库"按钮
   - 填写车辆详细信息
   - 上传车辆照片（自动压缩）
   - 系统会自动记录购车款成本

4. **客户展示**
   - 访问 `/customer-view` 页面
   - 无需登录即可查看在售车辆
   - 展示车辆照片、基本信息和车况

## 权限说明

### 员工权限（employee）
员工登录后可以：
- ✅ **录入新数据**：可以添加新车辆、新成本、新销售记录、新费用记录
- ✅ **上传图片**：可以上传车辆照片
- ✅ **查看数据**：可以查看所有车辆、员工、销售、费用等信息
- ❌ **不能修改**：不能修改任何已有的数据记录
- ❌ **不能删除**：不能删除任何数据
- ❌ **不能管理**：不能管理员工信息和角色分配

**UI 提示**：
- 车辆管理页面会显示"员工权限：可录入新车辆，不可修改已有数据"
- 编辑按钮会显示为锁定图标，点击时提示"只有管理员可以修改"
- 员工管理页面会显示"员工权限：仅查看，不可修改"

### 管理员权限（admin）
管理员拥有最高权限：
- ✅ **完全控制**：可以执行所有操作
- ✅ **修改数据**：可以修改所有已有数据
- ✅ **删除数据**：可以删除车辆、员工等数据
- ✅ **管理员工**：可以添加、编辑、停用员工
- ✅ **分配角色**：可以为员工分配利润分配角色
- ✅ **管理用户**：可以设置用户的系统角色（管理员/员工）
- ✅ **管理图片**：可以更新和删除车辆图片

**首个用户自动成为管理员**：
- 第一个注册的用户会自动获得管理员权限
- 管理员可以在"用户管理"页面将其他用户设置为管理员或员工

### 数据库层面权限控制（RLS）

系统在数据库层面实施了严格的行级安全策略（RLS）：

1. **车辆表（vehicles）**
   - 所有人可查看在售车辆（用于客户展示）
   - 认证用户可查看所有车辆
   - 员工可插入新车辆
   - 只有管理员可更新和删除车辆

2. **车辆成本表（vehicle_costs）**
   - 认证用户可查看所有成本
   - 员工可添加新成本
   - 只有管理员可更新和删除成本

3. **销售记录表（vehicle_sales）**
   - 认证用户可查看所有销售记录
   - 员工可创建新销售记录
   - 只有管理员可更新和删除销售记录

4. **费用记录表（expenses）**
   - 认证用户可查看所有费用
   - 员工可创建新费用记录
   - 只有管理员可更新和删除费用

5. **员工表（employees）**
   - 认证用户可查看所有员工信息
   - 只有管理员可管理员工信息

6. **员工角色表（employee_roles）**
   - 认证用户可查看所有角色分配
   - 只有管理员可管理角色分配

7. **利润分配表（profit_distributions）**
   - 认证用户可查看所有利润分配
   - 只有管理员可管理利润分配

8. **月度奖金表（monthly_bonuses）**
   - 认证用户可查看所有奖金记录
   - 只有管理员可管理奖金记录

9. **存储桶（vehicle_images）**
   - 所有人可查看图片
   - 员工可上传图片
   - 只有管理员可更新和删除图片

### 前端权限控制

系统在前端也实施了权限检查：

1. **按钮禁用**：非管理员用户的编辑按钮会被禁用
2. **视觉提示**：使用锁定图标和提示文字说明权限限制
3. **操作拦截**：在提交前检查用户权限，非法操作会显示错误提示
4. **UI 隐藏**：某些管理功能只对管理员显示（如"添加员工"按钮）

### 权限验证流程

```
用户操作 → 前端权限检查 → 数据库 RLS 策略 → 操作执行/拒绝
```

这种双重验证机制确保了数据安全：
- 前端检查提供良好的用户体验和即时反馈
- 数据库 RLS 策略提供最终的安全保障，防止绕过前端的恶意操作

### 图片上传说明

- **支持格式**: JPEG, PNG, WEBP, GIF, AVIF
- **文件大小**: 最大 1MB（超过会自动压缩）
- **文件命名**: 只能包含英文字母和数字
- **压缩策略**: 
  - 自动转换为 WEBP 格式
  - 最大分辨率 1920px
  - 质量设置 0.8（必要时降至 0.6）

## 演示数据

系统已预置6辆演示车辆：
- 宝马 5系 (2020年)
- 奥迪 A6L (2019年)
- 奔驰 E级 (2021年)
- 丰田 凯美瑞 (2018年)
- 本田 雅阁 (2019年)
- 大众 帕萨特 (2020年)

## 配色方案

系统采用专业的汽车行业配色：
- **主色调**: 深蓝色 (hsl(215, 85%, 35%)) - 专业、可信赖
- **辅助色**: 灰蓝色 (hsl(215, 15%, 92%)) - 柔和、舒适
- **强调色**: 活力橙 (hsl(25, 95%, 53%)) - 活力、醒目
- **侧边栏**: 深色主题 (hsl(215, 25%, 15%))

## 待完善功能

以下功能已有基础框架，需要进一步开发：

1. **销售管理完整流程**
   - 销售信息详细录入
   - 贷款返利计算
   - 自动更新车辆状态
   - 自动触发利润分配

2. **利润分配自动化**
   - 根据销售记录自动计算利润
   - 按角色比例自动分配
   - 月度奖金池累计
   - 销售冠军自动评选

3. **统计分析增强**
   - 月度销售趋势图表
   - 员工业绩排行榜
   - 利润分配明细报表
   - 数据导出功能

4. **内部通报系统**
   - 每日销售通报
   - 月度业绩通报
   - 奖金池情况展示

## 注意事项

1. **首次登录**: 请先注册账号，第一个注册的用户会自动成为管理员
2. **员工关联**: 添加员工时需要先有对应的用户账号
3. **车架号**: 车架号后六位必须唯一，作为车辆的唯一标识
4. **图片上传**: 上传的图片会自动压缩，确保文件名只包含英文字母和数字
5. **角色分配**: 同一角色可以由多个员工共同担任，通过分配比例控制

## 技术支持

如有问题，请检查：
1. 浏览器控制台是否有错误信息
2. 网络连接是否正常
3. Supabase 服务是否可用
4. 用户权限是否正确设置

## 版权信息

© 2026 二手车销售管理系统
