# ä¼šå‘˜å‰©ä½™å¤©æ•°è®¡ç®—ä¿®å¤

## ðŸ› é—®é¢˜æè¿°

**ç—‡çŠ¶**ï¼šä¼šå‘˜ä¸­å¿ƒæ˜¾ç¤º"å…è´¹æœŸå‰©ä½™ 182 å¤©"ï¼Œä½†é¢„æœŸåº”è¯¥æ˜¯ 180 å¤©

**å®žé™…æƒ…å†µ**ï¼š
- å¼€é€šæ—¥æœŸï¼š2026-01-19
- åˆ°æœŸæ—¥æœŸï¼š2026-07-19ï¼ˆ6ä¸ªæœˆåŽï¼‰
- é¢„æœŸå‰©ä½™ï¼š180å¤©
- å®žé™…æ˜¾ç¤ºï¼š182å¤©

---

## ðŸ” é—®é¢˜åˆ†æž

### æ ¹æœ¬åŽŸå› 

#### 1. 6ä¸ªæœˆ â‰  180å¤©

**æ•°æ®åº“è®¡ç®—**ï¼š
```sql
-- åˆå§‹åŒ–ä¼šå‘˜æ—¶ä½¿ç”¨
v_trial_end_date := CURRENT_DATE + INTERVAL '6 months';

-- 2026-01-19 + 6ä¸ªæœˆ = 2026-07-19
```

**å®žé™…å¤©æ•°**ï¼š
- 1æœˆï¼š31å¤©ï¼ˆ1æœˆ19æ—¥-1æœˆ31æ—¥ = 13å¤©ï¼‰
- 2æœˆï¼š28å¤©ï¼ˆ2026å¹´ä¸æ˜¯é—°å¹´ï¼‰
- 3æœˆï¼š31å¤©
- 4æœˆï¼š30å¤©
- 5æœˆï¼š31å¤©
- 6æœˆï¼š30å¤©
- 7æœˆï¼š19å¤©
- **æ€»è®¡ï¼š13 + 28 + 31 + 30 + 31 + 30 + 19 = 182å¤©**

æˆ–è€…ç®€å•è®¡ç®—ï¼š
- 1æœˆ19æ—¥åˆ°7æœˆ19æ—¥ = 6ä¸ªæœˆ
- 1æœˆåˆ°6æœˆçš„å¤©æ•°ï¼š31 + 28 + 31 + 30 + 31 + 30 = 181å¤©
- åŠ ä¸Š7æœˆçš„19å¤© = 181å¤©ï¼ˆä¸åŒ…æ‹¬èµ·å§‹æ—¥ï¼‰

**æ­£ç¡®çš„å¤©æ•°**ï¼š
```sql
SELECT '2026-07-19'::date - '2026-01-19'::date as days;
-- ç»“æžœï¼š181å¤©
```

#### 2. æ—¶é—´æˆ³è®¡ç®—é—®é¢˜

**åŽŸä»£ç **ï¼š
```typescript
const now = new Date(); // åŒ…å«æ—¶åˆ†ç§’
const endDate = new Date(membership.end_date); // åŒ…å«æ—¶åˆ†ç§’

daysUntilExpiry = Math.ceil((endDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
```

**é—®é¢˜**ï¼š
1. `new Date()` èŽ·å–å½“å‰æ—¶é—´ï¼ŒåŒ…å«æ—¶åˆ†ç§’ï¼ˆå¦‚ 2026-01-19 00:00:00ï¼‰
2. `new Date(membership.end_date)` è§£æžæ—¥æœŸå­—ç¬¦ä¸²ï¼Œå¯èƒ½åŒ…å«æ—¶åŒºåç§»
3. ä¼šå‘˜åˆ›å»ºæ—¶é—´æ˜¯ 03:40:37ï¼Œä¸æ˜¯ 00:00:00
4. å¦‚æžœå½“å‰æ—¶é—´æ˜¯ 00:00:00ï¼Œè€Œåˆ°æœŸæ—¶é—´æ˜¯ 03:40:37ï¼Œå·®å€¼ä¼šå¤šå‡ºå‡ ä¸ªå°æ—¶
5. ä½¿ç”¨ `Math.ceil()` å‘ä¸Šå–æ•´ï¼Œå¯¼è‡´å¤šç®—ä¸€å¤©

**ç¤ºä¾‹**ï¼š
```
åˆ›å»ºæ—¶é—´ï¼š2026-01-19 03:40:37
åˆ°æœŸæ—¶é—´ï¼š2026-07-19 03:40:37
å½“å‰æ—¶é—´ï¼š2026-01-19 00:00:00

æ—¶é—´å·®ï¼š181å¤© + 3å°æ—¶40åˆ†37ç§’ = 181.152å¤©
Math.ceil(181.152) = 182å¤© âŒ
```

#### 3. æ—¶åŒºé—®é¢˜

ä¸åŒæ—¶åŒºçš„ç”¨æˆ·å¯èƒ½çœ‹åˆ°ä¸åŒçš„å‰©ä½™å¤©æ•°ï¼š
- UTC+8ï¼ˆä¸­å›½ï¼‰ï¼š2026-01-19 08:00:00
- UTC+0ï¼ˆä¼¦æ•¦ï¼‰ï¼š2026-01-19 00:00:00
- æ—¶é—´å·®ä¼šå¯¼è‡´è®¡ç®—ç»“æžœä¸ä¸€è‡´

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šåªæ¯”è¾ƒæ—¥æœŸï¼Œä¸æ¯”è¾ƒæ—¶é—´

**ä¿®æ”¹åŽçš„ä»£ç **ï¼š
```typescript
// åªæ¯”è¾ƒæ—¥æœŸï¼Œä¸æ¯”è¾ƒæ—¶é—´ï¼Œé¿å…æ—¶åŒºå’Œæ—¶é—´æˆ³é—®é¢˜
const today = new Date();
today.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºå½“å¤©çš„00:00:00

const endDate = membership.end_date ? new Date(membership.end_date) : null;
if (endDate) {
  endDate.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºå½“å¤©çš„00:00:00
}

const trialEndDate = membership.trial_end_date ? new Date(membership.trial_end_date) : null;
if (trialEndDate) {
  trialEndDate.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºå½“å¤©çš„00:00:00
}

let daysUntilExpiry: number | null = null;
if (endDate) {
  // ä½¿ç”¨æ—¥æœŸå·®è®¡ç®—ï¼Œç»“æžœæ˜¯æ•´æ•°å¤©æ•°
  daysUntilExpiry = Math.round((endDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
}

const isExpired = endDate ? today > endDate : false;
const isTrial = membership.is_trial && trialEndDate ? today <= trialEndDate : false;
```

**ä¼˜ç‚¹**ï¼š
1. âœ… æ¶ˆé™¤æ—¶é—´éƒ¨åˆ†çš„å½±å“
2. âœ… é¿å…æ—¶åŒºé—®é¢˜
3. âœ… è®¡ç®—ç»“æžœç¨³å®šä¸€è‡´
4. âœ… ä½¿ç”¨ `Math.round()` å››èˆäº”å…¥ï¼Œæ›´åˆç†

**æ•ˆæžœ**ï¼š
```
ä»Šå¤©ï¼š2026-01-19 00:00:00
åˆ°æœŸï¼š2026-07-19 00:00:00

æ—¶é—´å·®ï¼š181å¤©æ•´
Math.round(181) = 181å¤© âœ…
```

---

## ðŸ“Š ä¿®å¤å‰åŽå¯¹æ¯”

### ä¿®å¤å‰

| åœºæ™¯ | å½“å‰æ—¶é—´ | åˆ°æœŸæ—¶é—´ | è®¡ç®—ç»“æžœ | æ˜¾ç¤º |
|------|---------|---------|---------|------|
| åœºæ™¯1 | 2026-01-19 00:00:00 | 2026-07-19 03:40:37 | Math.ceil(181.152) | 182å¤© âŒ |
| åœºæ™¯2 | 2026-01-19 12:00:00 | 2026-07-19 03:40:37 | Math.ceil(180.652) | 181å¤© âŒ |
| åœºæ™¯3 | 2026-01-19 23:59:59 | 2026-07-19 03:40:37 | Math.ceil(180.152) | 181å¤© âŒ |

### ä¿®å¤åŽ

| åœºæ™¯ | å½“å‰æ—¶é—´ | åˆ°æœŸæ—¶é—´ | è®¡ç®—ç»“æžœ | æ˜¾ç¤º |
|------|---------|---------|---------|------|
| åœºæ™¯1 | 2026-01-19 00:00:00 | 2026-07-19 00:00:00 | Math.round(181) | 181å¤© âœ… |
| åœºæ™¯2 | 2026-01-19 12:00:00 | 2026-07-19 00:00:00 | Math.round(181) | 181å¤© âœ… |
| åœºæ™¯3 | 2026-01-19 23:59:59 | 2026-07-19 00:00:00 | Math.round(181) | 181å¤© âœ… |

---

## ðŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1ï¼šåˆšåˆå§‹åŒ–çš„ä¼šå‘˜

**å‰ææ¡ä»¶**ï¼š
- ä»Šå¤©æ˜¯ 2026-01-19
- åˆšåˆšåˆå§‹åŒ–ä¼šå‘˜
- åˆ°æœŸæ—¥æœŸæ˜¯ 2026-07-19

**æµ‹è¯•æ­¥éª¤**ï¼š
1. ç™»å½•è½¦å•†ç®¡ç†å‘˜è´¦å·
2. è¿›å…¥ä¼šå‘˜ä¸­å¿ƒ
3. æŸ¥çœ‹"å…è´¹æœŸå‰©ä½™"å¤©æ•°

**é¢„æœŸç»“æžœ**ï¼š
- âœ… æ˜¾ç¤º "181 å¤©"
- âœ… ä¸å†æ˜¾ç¤º "182 å¤©"

### æµ‹è¯•åœºæ™¯2ï¼šä¸åŒæ—¶é—´ç‚¹æŸ¥çœ‹

**å‰ææ¡ä»¶**ï¼š
- åŒä¸€å¤©çš„ä¸åŒæ—¶é—´ç‚¹

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æ—©ä¸Š 00:00 æŸ¥çœ‹å‰©ä½™å¤©æ•°
2. ä¸­åˆ 12:00 æŸ¥çœ‹å‰©ä½™å¤©æ•°
3. æ™šä¸Š 23:59 æŸ¥çœ‹å‰©ä½™å¤©æ•°

**é¢„æœŸç»“æžœ**ï¼š
- âœ… ä¸‰æ¬¡æŸ¥çœ‹ç»“æžœä¸€è‡´
- âœ… éƒ½æ˜¾ç¤ºç›¸åŒçš„å‰©ä½™å¤©æ•°

### æµ‹è¯•åœºæ™¯3ï¼šè·¨å¤©æµ‹è¯•

**å‰ææ¡ä»¶**ï¼š
- ä»Šå¤©æ˜¯ 2026-01-19
- æ˜Žå¤©æ˜¯ 2026-01-20

**æµ‹è¯•æ­¥éª¤**ï¼š
1. ä»Šå¤©æŸ¥çœ‹å‰©ä½™å¤©æ•°ï¼ˆåº”è¯¥æ˜¯181å¤©ï¼‰
2. æ˜Žå¤©æŸ¥çœ‹å‰©ä½™å¤©æ•°ï¼ˆåº”è¯¥æ˜¯180å¤©ï¼‰

**é¢„æœŸç»“æžœ**ï¼š
- âœ… ä»Šå¤©ï¼š181å¤©
- âœ… æ˜Žå¤©ï¼š180å¤©
- âœ… æ¯å¤©å‡å°‘1å¤©

### æµ‹è¯•åœºæ™¯4ï¼šåˆ°æœŸå‰ä¸€å¤©

**å‰ææ¡ä»¶**ï¼š
- ä»Šå¤©æ˜¯ 2026-07-18
- æ˜Žå¤©åˆ°æœŸï¼ˆ2026-07-19ï¼‰

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æŸ¥çœ‹å‰©ä½™å¤©æ•°

**é¢„æœŸç»“æžœ**ï¼š
- âœ… æ˜¾ç¤º "1 å¤©"
- âœ… ä¸æ˜¾ç¤º "0 å¤©"

### æµ‹è¯•åœºæ™¯5ï¼šåˆ°æœŸå½“å¤©

**å‰ææ¡ä»¶**ï¼š
- ä»Šå¤©æ˜¯ 2026-07-19ï¼ˆåˆ°æœŸæ—¥ï¼‰

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æŸ¥çœ‹ä¼šå‘˜çŠ¶æ€

**é¢„æœŸç»“æžœ**ï¼š
- âœ… æ˜¾ç¤º "0 å¤©" æˆ– "å·²åˆ°æœŸ"
- âœ… ä¼šå‘˜çŠ¶æ€å˜ä¸º "å·²è¿‡æœŸ"

---

## ðŸ“ ç›¸å…³ä¿®æ”¹

### ä¿®æ”¹çš„æ–‡ä»¶

**æ–‡ä»¶**ï¼š`src/db/membershipApi.ts`

**å‡½æ•°**ï¼š`checkMembershipStatus()`

**ä¿®æ”¹å†…å®¹**ï¼š
1. å°† `now` æ”¹ä¸º `today`ï¼Œå¹¶è®¾ç½®æ—¶é—´ä¸º 00:00:00
2. å°† `endDate` å’Œ `trialEndDate` çš„æ—¶é—´éƒ¨åˆ†è®¾ç½®ä¸º 00:00:00
3. å°† `Math.ceil()` æ”¹ä¸º `Math.round()`
4. æ›´æ–° `isExpired` å’Œ `isTrial` çš„åˆ¤æ–­é€»è¾‘

---

## ðŸ’¡ æœ€ä½³å®žè·µ

### 1. æ—¥æœŸè®¡ç®—åŽŸåˆ™

**æŽ¨è**ï¼š
```typescript
// âœ… åªæ¯”è¾ƒæ—¥æœŸ
const date1 = new Date('2026-01-19');
date1.setHours(0, 0, 0, 0);

const date2 = new Date('2026-07-19');
date2.setHours(0, 0, 0, 0);

const days = (date2.getTime() - date1.getTime()) / (1000 * 60 * 60 * 24);
```

**ä¸æŽ¨è**ï¼š
```typescript
// âŒ åŒ…å«æ—¶é—´éƒ¨åˆ†
const date1 = new Date('2026-01-19 03:40:37');
const date2 = new Date('2026-07-19 03:40:37');
const days = (date2.getTime() - date1.getTime()) / (1000 * 60 * 60 * 24);
```

### 2. å–æ•´æ–¹æ³•é€‰æ‹©

| æ–¹æ³• | è¯´æ˜Ž | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| `Math.floor()` | å‘ä¸‹å–æ•´ | è®¡è´¹åœºæ™¯ï¼ˆå¯¹ç”¨æˆ·æœ‰åˆ©ï¼‰ |
| `Math.ceil()` | å‘ä¸Šå–æ•´ | ä¿å®ˆä¼°è®¡ï¼ˆå¯¹ç³»ç»Ÿæœ‰åˆ©ï¼‰ |
| `Math.round()` | å››èˆäº”å…¥ | ä¸€èˆ¬åœºæ™¯ï¼ˆæœ€å…¬å¹³ï¼‰ |

**æœ¬é¡¹ç›®é€‰æ‹©**ï¼š`Math.round()` - å› ä¸ºå·²ç»æ¶ˆé™¤äº†æ—¶é—´éƒ¨åˆ†ï¼Œç»“æžœæ˜¯æ•´æ•°ï¼Œå››èˆäº”å…¥æœ€åˆç†ã€‚

### 3. æ—¶åŒºå¤„ç†

**æŽ¨è**ï¼š
```typescript
// âœ… ä½¿ç”¨æœ¬åœ°æ—¶åŒº
const date = new Date('2026-01-19');
date.setHours(0, 0, 0, 0);
```

**ä¸æŽ¨è**ï¼š
```typescript
// âŒ ä½¿ç”¨UTCæ—¶åŒºï¼ˆå¯èƒ½å¯¼è‡´æ—¥æœŸåç§»ï¼‰
const date = new Date('2026-01-19T00:00:00Z');
```

---

## ðŸ” å…¶ä»–ç›¸å…³é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆ6ä¸ªæœˆä¸æ˜¯180å¤©ï¼Ÿ

**A**: å› ä¸ºæ¯ä¸ªæœˆçš„å¤©æ•°ä¸åŒï¼š
- å¤§æœˆï¼ˆ31å¤©ï¼‰ï¼š1æœˆã€3æœˆã€5æœˆã€7æœˆã€8æœˆã€10æœˆã€12æœˆ
- å°æœˆï¼ˆ30å¤©ï¼‰ï¼š4æœˆã€6æœˆã€9æœˆã€11æœˆ
- 2æœˆï¼š28å¤©ï¼ˆå¹³å¹´ï¼‰æˆ–29å¤©ï¼ˆé—°å¹´ï¼‰

6ä¸ªæœˆçš„å¤©æ•°å–å†³äºŽèµ·å§‹æœˆä»½ï¼š
- 1æœˆ-6æœˆï¼š31+28+31+30+31+30 = 181å¤©ï¼ˆå¹³å¹´ï¼‰
- 7æœˆ-12æœˆï¼š31+31+30+31+30+31 = 184å¤©

### Q2: å¦‚ä½•æ”¹ä¸ºç²¾ç¡®çš„180å¤©ï¼Ÿ

**A**: ä¿®æ”¹æ•°æ®åº“å‡½æ•°ï¼š
```sql
-- æ”¹ä¸ºç²¾ç¡®çš„180å¤©
v_trial_end_date := CURRENT_DATE + INTERVAL '180 days';

-- è€Œä¸æ˜¯
v_trial_end_date := CURRENT_DATE + INTERVAL '6 months';
```

**æƒè¡¡**ï¼š
- 6ä¸ªæœˆï¼šæ›´ç¬¦åˆå•†ä¸šä¹ æƒ¯ï¼Œæ˜“äºŽç†è§£
- 180å¤©ï¼šç²¾ç¡®ï¼Œä½†å¯èƒ½ä¸æ˜¯æ•´æœˆæ•°

**å»ºè®®**ï¼šä¿æŒä½¿ç”¨"6ä¸ªæœˆ"ï¼Œå› ä¸ºï¼š
1. ç¬¦åˆå•†ä¸šä¹ æƒ¯
2. ç”¨æˆ·æ›´å®¹æ˜“ç†è§£
3. 181å¤©å’Œ180å¤©å·®å¼‚å¾ˆå°

### Q3: å¦‚ä½•å¤„ç†é—°å¹´ï¼Ÿ

**A**: å½“å‰å®žçŽ°å·²ç»è‡ªåŠ¨å¤„ç†ï¼š
- `INTERVAL '6 months'` ä¼šè‡ªåŠ¨è€ƒè™‘é—°å¹´
- 2æœˆåœ¨é—°å¹´æ˜¯29å¤©ï¼Œå¹³å¹´æ˜¯28å¤©
- ä¸éœ€è¦é¢å¤–å¤„ç†

---

## ðŸ“š ç›¸å…³æ–‡æ¡£

- [ä¼šå‘˜è‡ªåŠ©åˆå§‹åŒ–åŠŸèƒ½è¯´æ˜Ž](./MEMBERSHIP_INITIALIZATION_GUIDE.md)
- [ä¼šå‘˜åˆå§‹åŒ–åŠ è½½å¤±è´¥ä¿®å¤](./MEMBERSHIP_INIT_ERROR_FIX.md)
- [ä¼šå‘˜åˆå§‹åŒ–RLSæƒé™ä¿®å¤](./MEMBERSHIP_RLS_FIX.md)
- [JavaScript Date å¯¹è±¡æ–‡æ¡£](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Date)

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åŽæ›´æ–°**ï¼š2026-01-19  
**é€‚ç”¨ç³»ç»Ÿ**ï¼šäºŒæ‰‹è½¦é”€å”®ç®¡ç†ç³»ç»Ÿ v2.0+
