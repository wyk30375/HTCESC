# 会员状态测试数据说明

## 📊 测试车行概览

已创建三个模拟车行，用于测试不同的会员状态场景：

| 车行名称 | 车行ID | 所在城市 | 车辆数量 | 会员等级 | 会员状态 | 剩余天数 |
|---------|--------|---------|---------|---------|---------|---------|
| 鸿运二手车 | 11111111-1111-1111-1111-111111111111 | 深圳市 | 15台 | 三级会员 | 已续费会员 | 300天 |
| 顺达汽车 | 22222222-2222-2222-2222-222222222222 | 杭州市 | 30台 | 二级会员 | 免费期会员 | 150天 |
| 盛世车行 | 33333333-3333-3333-3333-333333333333 | 南京市 | 8台 | 三级会员 | 免费期即将到期 | 5天 |

---

## 🚗 车行1：鸿运二手车（已续费会员）

### 基本信息
- **车行ID**：`11111111-1111-1111-1111-111111111111`
- **车行名称**：鸿运二手车
- **车行代码**：hongyun
- **所在地区**：广东省 深圳市 南山区
- **联系人**：张三
- **联系电话**：13900000001

### 车辆信息
- **车辆数量**：15台
- **车辆状态**：全部在库（in_stock）
- **车架号范围**：HY0001 ~ HY0015
- **车牌号范围**：粤B00001 ~ 粤B00015
- **品牌分布**：奔驰、宝马、奥迪、丰田、本田

### 会员信息
- **会员等级**：三级会员（0-20台车辆）
- **年费**：¥198
- **会员状态**：active（正常会员）
- **是否试用期**：否
- **开始日期**：65天前
- **结束日期**：300天后
- **剩余天数**：300天
- **状态标识**：已续费会员

### 支付记录
- **支付金额**：¥198.00
- **支付方式**：线下支付
- **支付状态**：已完成
- **支付日期**：65天前
- **交易流水号**：PAY20260101001
- **备注**：线下支付续费

### 测试场景
✅ 正常付费会员
✅ 非试用期
✅ 会员期限充足（300天）
✅ 不需要续费提醒
✅ 可以正常使用所有功能

---

## 🚗 车行2：顺达汽车（免费期会员）

### 基本信息
- **车行ID**：`22222222-2222-2222-2222-222222222222`
- **车行名称**：顺达汽车
- **车行代码**：shunda
- **所在地区**：浙江省 杭州市 西湖区
- **联系人**：李四
- **联系电话**：13900000002

### 车辆信息
- **车辆数量**：30台
- **车辆状态**：全部在库（in_stock）
- **车架号范围**：SD0001 ~ SD0030
- **车牌号范围**：浙A00001 ~ 浙A00030
- **品牌分布**：大众、别克、日产、马自达、现代

### 会员信息
- **会员等级**：二级会员（21-50台车辆）
- **年费**：¥365
- **会员状态**：active（正常会员）
- **是否试用期**：是
- **开始日期**：30天前
- **试用期结束日期**：150天后
- **正式会员结束日期**：335天后
- **剩余天数**：150天（试用期）
- **状态标识**：免费期会员（trial）

### 支付记录
- 无支付记录（免费期内）

### 测试场景
✅ 免费期会员
✅ 试用期内
✅ 试用期剩余时间充足（150天）
✅ 不需要立即续费
✅ 可以正常使用所有功能
✅ 会员中心显示"免费期"标识

---

## 🚗 车行3：盛世车行（免费期即将到期）

### 基本信息
- **车行ID**：`33333333-3333-3333-3333-333333333333`
- **车行名称**：盛世车行
- **车行代码**：shengshi
- **所在地区**：江苏省 南京市 鼓楼区
- **联系人**：王五
- **联系电话**：13900000003

### 车辆信息
- **车辆数量**：8台
- **车辆状态**：全部在库（in_stock）
- **车架号范围**：SS0001 ~ SS0008
- **车牌号范围**：苏A00001 ~ 苏A00008
- **品牌分布**：福特、雪佛兰、起亚、标致

### 会员信息
- **会员等级**：三级会员（0-20台车辆）
- **年费**：¥198
- **会员状态**：active（正常会员）
- **是否试用期**：是
- **开始日期**：175天前
- **试用期结束日期**：5天后
- **正式会员结束日期**：190天后
- **剩余天数**：5天（试用期）
- **状态标识**：免费期会员（trial）

### 支付记录
- 无支付记录（免费期内）

### 测试场景
✅ 免费期会员
✅ 试用期即将到期（仅剩5天）
⚠️ 需要显示续费提醒
⚠️ 会员中心应该突出显示到期提醒
✅ 可以正常使用所有功能
✅ 测试续费流程的最佳场景

---

## 🧪 测试验证

### 验证SQL查询

#### 查询所有测试车行的会员状态
```sql
SELECT 
  d.name as 车行名称,
  (check_membership_status(d.id)::json->>'status')::text as 会员状态,
  (check_membership_status(d.id)::json->>'isTrial')::boolean as 是否试用期,
  (check_membership_status(d.id)::json->>'daysRemaining')::integer as 剩余天数,
  (check_membership_status(d.id)::json->>'tierName')::text as 会员等级,
  (check_membership_status(d.id)::json->>'vehicleCount')::integer as 车辆数量
FROM dealerships d
WHERE d.id IN (
  '11111111-1111-1111-1111-111111111111',
  '22222222-2222-2222-2222-222222222222',
  '33333333-3333-3333-3333-333333333333'
)
ORDER BY d.name;
```

#### 查询车辆统计
```sql
SELECT 
  d.name as 车行名称,
  COUNT(v.id) as 车辆数量,
  COUNT(CASE WHEN v.status = 'in_stock' THEN 1 END) as 在库数量,
  COUNT(CASE WHEN v.status = 'sold' THEN 1 END) as 已售数量
FROM dealerships d
LEFT JOIN vehicles v ON d.id = v.dealership_id
WHERE d.id IN (
  '11111111-1111-1111-1111-111111111111',
  '22222222-2222-2222-2222-222222222222',
  '33333333-3333-3333-3333-333333333333'
)
GROUP BY d.id, d.name
ORDER BY d.name;
```

#### 查询会员详细信息
```sql
SELECT 
  d.name as 车行名称,
  dm.is_trial as 是否试用期,
  dm.start_date as 开始日期,
  dm.end_date as 结束日期,
  dm.trial_end_date as 试用期结束日期,
  CASE 
    WHEN dm.is_trial THEN dm.trial_end_date - CURRENT_DATE
    ELSE dm.end_date - CURRENT_DATE
  END as 剩余天数,
  mt.tier_name as 会员等级,
  mt.annual_fee as 年费,
  dm.status as 状态
FROM dealership_memberships dm
JOIN dealerships d ON dm.dealership_id = d.id
JOIN membership_tiers mt ON dm.tier_id = mt.id
WHERE d.id IN (
  '11111111-1111-1111-1111-111111111111',
  '22222222-2222-2222-2222-222222222222',
  '33333333-3333-3333-3333-333333333333'
)
ORDER BY d.name;
```

#### 查询支付记录
```sql
SELECT 
  d.name as 车行名称,
  mp.amount as 支付金额,
  mp.payment_method as 支付方式,
  mp.payment_status as 支付状态,
  mp.payment_date as 支付日期,
  mp.transaction_id as 交易流水号,
  mp.notes as 备注
FROM membership_payments mp
JOIN dealerships d ON mp.dealership_id = d.id
WHERE d.id IN (
  '11111111-1111-1111-1111-111111111111',
  '22222222-2222-2222-2222-222222222222',
  '33333333-3333-3333-3333-333333333333'
)
ORDER BY d.name, mp.payment_date DESC;
```

---

## 📱 前端测试指南

### 使用平台管理员账号测试

#### 步骤1：登录平台管理后台
1. 使用超级管理员账号登录
2. 进入"平台管理"模式

#### 步骤2：查看车行列表
1. 点击左侧菜单"车行管理"
2. 在车行列表中找到三个测试车行：
   - 鸿运二手车
   - 顺达汽车
   - 盛世车行

#### 步骤3：查看会员管理
1. 点击左侧菜单"会员管理"
2. 查看三个车行的会员状态
3. 验证显示的信息是否正确：
   - 鸿运二手车：正常会员，剩余300天
   - 顺达汽车：免费期，剩余150天
   - 盛世车行：免费期，剩余5天（应该显示到期提醒）

#### 步骤4：测试续费功能
1. 选择"盛世车行"（即将到期）
2. 点击"续费"按钮
3. 选择会员等级（三级会员）
4. 选择支付方式（线下支付）
5. 输入交易流水号和备注
6. 确认续费
7. 验证续费成功后的状态变化

---

## 🎯 测试场景清单

### 场景1：正常会员显示
- [ ] 鸿运二手车会员中心显示正常
- [ ] 显示会员等级：三级会员
- [ ] 显示剩余天数：300天
- [ ] 不显示"免费期"标识
- [ ] 不显示到期提醒

### 场景2：免费期会员显示
- [ ] 顺达汽车会员中心显示正常
- [ ] 显示会员等级：二级会员
- [ ] 显示剩余天数：150天
- [ ] 显示"免费期"标识
- [ ] 不显示到期提醒（剩余时间充足）

### 场景3：免费期即将到期提醒
- [ ] 盛世车行会员中心显示正常
- [ ] 显示会员等级：三级会员
- [ ] 显示剩余天数：5天
- [ ] 显示"免费期"标识
- [ ] 显示到期提醒（醒目提示）
- [ ] 提供续费入口

### 场景4：在线支付测试
- [ ] 盛世车行点击"扫码支付"
- [ ] 生成支付二维码
- [ ] 模拟支付成功
- [ ] 会员状态更新为正常会员
- [ ] 剩余天数更新为365天

### 场景5：平台管理员续费
- [ ] 平台管理员进入会员管理
- [ ] 选择盛世车行
- [ ] 点击续费按钮
- [ ] 填写续费信息
- [ ] 确认续费
- [ ] 验证会员状态更新

### 场景6：车辆数量变化
- [ ] 为鸿运二手车添加更多车辆（超过20台）
- [ ] 验证会员等级自动升级为二级会员
- [ ] 删除部分车辆（少于20台）
- [ ] 验证会员等级自动降级为三级会员

---

## 🔧 数据清理

### 删除测试数据

如果需要清理测试数据，执行以下SQL：

```sql
-- 删除测试车行的会员记录
DELETE FROM dealership_memberships
WHERE dealership_id IN (
  '11111111-1111-1111-1111-111111111111',
  '22222222-2222-2222-2222-222222222222',
  '33333333-3333-3333-3333-333333333333'
);

-- 删除测试车行的支付记录
DELETE FROM membership_payments
WHERE dealership_id IN (
  '11111111-1111-1111-1111-111111111111',
  '22222222-2222-2222-2222-222222222222',
  '33333333-3333-3333-3333-333333333333'
);

-- 删除测试车行的车辆
DELETE FROM vehicles
WHERE dealership_id IN (
  '11111111-1111-1111-1111-111111111111',
  '22222222-2222-2222-2222-222222222222',
  '33333333-3333-3333-3333-333333333333'
);

-- 删除测试车行
DELETE FROM dealerships
WHERE id IN (
  '11111111-1111-1111-1111-111111111111',
  '22222222-2222-2222-2222-222222222222',
  '33333333-3333-3333-3333-333333333333'
);
```

---

## 📝 注意事项

### 1. 会员状态判定规则
- `trial`: 免费期会员
- `active`: 正常付费会员
- `expiring_soon`: 即将到期（剩余7天内）
- `expired`: 已到期
- `no_membership`: 未开通会员

### 2. 到期提醒规则
- 剩余天数 > 7天：不显示提醒
- 剩余天数 ≤ 7天：显示到期提醒
- 剩余天数 ≤ 0天：显示已到期，限制功能

### 3. 会员等级自动判定
- 系统根据在售车辆数量自动判定会员等级
- 车辆状态变更时自动更新会员等级
- 只统计状态为 `in_stock` 的车辆

### 4. 续费规则
- 如果当前会员未过期，从当前结束日期开始延期1年
- 如果当前会员已过期，从今天开始计算1年
- 续费后原会员记录状态更新为 `cancelled`
- 创建新的会员记录，状态为 `active`

---

## 📚 相关文档

- [会员制系统功能说明](./MEMBERSHIP_SYSTEM_GUIDE.md)
- [在线支付功能说明](./ONLINE_PAYMENT_GUIDE.md)
- [会员中心加载失败修复说明](./MEMBERSHIP_ERROR_FIX.md)
- [如何找到在线支付控件](./HOW_TO_FIND_PAYMENT.md)

---

**文档版本**：v1.0  
**最后更新**：2026-01-19  
**适用系统**：二手车销售管理系统 v2.0+
