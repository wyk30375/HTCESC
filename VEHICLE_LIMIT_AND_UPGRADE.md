# 车辆数量限制与会员升级功能

## 📋 功能概述

根据会员等级限制在售车辆数量，当车辆数量达到上限时提醒车行升级会员。在会员中心提供便捷的会员升级入口，方便车行随时升级会员等级。

---

## 🎯 核心功能

### 1. 车辆数量限制检查

**功能描述**：
- 根据会员等级自动限制在售车辆数量
- 添加车辆时自动检查是否超过限制
- 超限时阻止添加并提示升级会员

**会员等级限制**：
| 会员等级 | 车辆数量限制 | 年费 |
|---------|------------|------|
| 一级会员 | 1-10台 | ¥680 |
| 二级会员 | 11-30台 | ¥1,280 |
| 三级会员 | 31-50台 | ¥1,880 |
| 四级会员 | 51台以上 | ¥2,680 |

### 2. 多层次提醒机制

#### 2.1 车辆管理页面提醒

**达到上限（100%）**：
- 显示红色警告提示
- 明确说明已达上限，无法继续添加
- 提供"升级会员"按钮，直接跳转到会员中心

**接近上限（≥80%）**：
- 显示黄色提示
- 建议提前升级会员
- 提供"查看会员"按钮

#### 2.2 会员中心提醒

**车辆数量超限提示**：
- 显示当前车辆数量和会员等级上限
- 提供"升级会员"按钮
- 说明升级后可继续添加车辆

**等级变化建议**：
- 根据当前车辆数量推荐合适的会员等级
- 提供"立即升级"按钮

#### 2.3 添加车辆时提醒

**前端检查**：
- 提交前检查车辆数量限制
- 显示Toast提示，包含"升级会员"操作按钮
- 阻止表单提交

**后端检查（数据库触发器）**：
- 在INSERT/UPDATE时自动检查
- 如果超限，抛出异常阻止操作
- 确保数据一致性

### 3. 会员升级功能

#### 3.1 推荐等级显示

**智能推荐**：
- 根据当前在售车辆数量自动计算推荐等级
- 在会员中心显著位置展示推荐等级
- 提供一键升级功能

#### 3.2 选择其他等级

**灵活选择**：
- 提供"选择其他会员等级"折叠面板
- 显示所有会员等级的详细信息
- 支持选择任意等级（包括低于推荐等级）
- 标记推荐等级

#### 3.3 升级流程

**操作步骤**：
1. 点击"立即升级"或"选择此等级"按钮
2. 打开支付对话框，显示二维码
3. 扫码支付（或模拟支付）
4. 系统自动检测支付状态
5. 支付成功后自动更新会员等级
6. 刷新页面显示新的会员信息

---

## 🔧 技术实现

### 1. 数据库层

#### 1.1 检查函数

```sql
CREATE FUNCTION check_vehicle_limit(p_dealership_id UUID)
RETURNS JSON
```

**功能**：
- 查询当前在售车辆数量
- 获取会员等级限制
- 判断是否允许添加车辆
- 返回检查结果（JSON格式）

**返回值**：
```json
{
  "allowed": true/false,
  "current_count": 5,
  "max_vehicles": 10,
  "tier_name": "一级会员",
  "message": "可以添加车辆，当前5/10台"
}
```

#### 1.2 触发器

```sql
CREATE TRIGGER trigger_check_vehicle_limit
  BEFORE INSERT OR UPDATE ON vehicles
  FOR EACH ROW
  EXECUTE FUNCTION check_vehicle_limit_trigger();
```

**功能**：
- 在添加或更新车辆前自动检查
- 只检查状态为'in_stock'的车辆
- 超限时抛出异常，阻止操作
- 确保数据库层面的数据一致性

**触发条件**：
- INSERT且status='in_stock'
- UPDATE且status从非'in_stock'变为'in_stock'

### 2. API层

#### 2.1 车辆限制检查API

**文件**：`src/db/membershipApi.ts`

```typescript
export async function checkVehicleLimit(dealershipId: string): Promise<{
  allowed: boolean;
  current_count: number;
  max_vehicles: number | null;
  tier_name: string | null;
  message: string;
}>
```

**功能**：
- 调用数据库RPC函数
- 返回车辆限制检查结果
- 供前端页面使用

### 3. 前端层

#### 3.1 车辆管理页面

**文件**：`src/pages/Vehicles.tsx`

**新增功能**：
1. 加载车辆限制信息
2. 显示车辆数量提示（达到上限/接近上限）
3. 添加车辆前检查限制
4. 提供升级会员入口

**关键代码**：
```typescript
// 加载车辆限制
const [vehicleLimit, setVehicleLimit] = useState<any>(null);

// 检查限制
if (!editingVehicle && vehicleLimit && !vehicleLimit.allowed) {
  toast.error(vehicleLimit.message, {
    action: {
      label: '升级会员',
      onClick: () => navigate('/membership-center')
    }
  });
  return;
}
```

#### 3.2 会员中心页面

**文件**：`src/pages/MembershipCenter.tsx`

**新增功能**：
1. 车辆数量限制提示
2. 等级变化建议（带升级按钮）
3. 选择其他会员等级（折叠面板）
4. 一键升级功能

**关键组件**：
- 车辆数量限制Alert（红色警告）
- 等级变化建议Alert（带"立即升级"按钮）
- 选择其他等级（details折叠面板）
- 会员等级卡片（可点击选择）

---

## 🧪 测试场景

### 场景1：车辆数量未达上限

**前提条件**：
- 一级会员（上限10台）
- 当前在售车辆5台

**测试步骤**：
1. 进入车辆管理页面
2. 点击"车辆入库"按钮
3. 填写车辆信息并提交

**预期结果**：
- ✅ 不显示限制提示
- ✅ 车辆成功入库
- ✅ 车辆数量变为6台

### 场景2：车辆数量接近上限（80%-99%）

**前提条件**：
- 一级会员（上限10台）
- 当前在售车辆8台（80%）

**测试步骤**：
1. 进入车辆管理页面
2. 查看页面顶部提示

**预期结果**：
- ✅ 显示黄色提示："您的在售车辆数量（8台）接近一级会员的上限（10台）"
- ✅ 提供"查看会员"按钮
- ✅ 仍可以添加车辆

### 场景3：车辆数量达到上限（100%）

**前提条件**：
- 一级会员（上限10台）
- 当前在售车辆10台

**测试步骤**：
1. 进入车辆管理页面
2. 查看页面顶部提示
3. 点击"车辆入库"按钮
4. 填写车辆信息并提交

**预期结果**：
- ✅ 显示红色警告："车辆数量已达上限！"
- ✅ 提供"升级会员"按钮
- ✅ 提交时显示Toast错误提示
- ✅ Toast包含"升级会员"操作按钮
- ✅ 车辆无法入库

### 场景4：会员中心查看限制提示

**前提条件**：
- 一级会员（上限10台）
- 当前在售车辆10台

**测试步骤**：
1. 进入会员中心
2. 查看"当前会员状态"卡片

**预期结果**：
- ✅ 显示红色Alert："您的在售车辆数量（10台）已达到一级会员的上限（10台）"
- ✅ 提供"升级会员"按钮
- ✅ 显示等级变化建议："建议升级到二级会员"
- ✅ 提供"立即升级"按钮

### 场景5：升级会员流程

**前提条件**：
- 一级会员（上限10台）
- 当前在售车辆10台

**测试步骤**：
1. 进入会员中心
2. 点击"立即升级"按钮
3. 查看支付对话框
4. 点击"模拟支付成功"按钮
5. 等待支付确认

**预期结果**：
- ✅ 打开支付对话框，显示二级会员信息
- ✅ 显示支付金额：¥1,280
- ✅ 显示二维码
- ✅ 模拟支付成功
- ✅ 显示"支付成功！会员已开通"提示
- ✅ 页面自动刷新
- ✅ 会员等级变为"二级会员"
- ✅ 车辆数量限制变为30台
- ✅ 可以继续添加车辆

### 场景6：选择其他会员等级

**前提条件**：
- 一级会员（上限10台）
- 当前在售车辆5台
- 系统推荐一级会员

**测试步骤**：
1. 进入会员中心
2. 滚动到"在线续费"区域
3. 点击"选择其他会员等级"
4. 查看所有会员等级
5. 点击"三级会员"的"选择此等级"按钮

**预期结果**：
- ✅ 折叠面板展开
- ✅ 显示4个会员等级卡片
- ✅ 一级会员标记为"推荐"
- ✅ 点击三级会员后打开支付对话框
- ✅ 显示三级会员信息（¥1,880/年）
- ✅ 可以完成支付和升级

### 场景7：数据库触发器保护

**前提条件**：
- 一级会员（上限10台）
- 当前在售车辆10台
- 尝试绕过前端检查直接插入数据

**测试步骤**：
1. 使用SQL直接插入车辆记录
```sql
INSERT INTO vehicles (dealership_id, status, ...)
VALUES ('车行ID', 'in_stock', ...);
```

**预期结果**：
- ✅ 数据库抛出异常
- ✅ 错误信息："已达到一级会员的车辆数量上限（10台），请升级会员后继续添加"
- ✅ 插入失败
- ✅ 数据一致性得到保护

---

## 📊 用户体验优化

### 1. 多层次提醒

**渐进式提醒**：
- 80%：温馨提示（黄色）
- 100%：严重警告（红色）
- 添加时：阻止操作+引导升级

**好处**：
- 提前预警，避免突然无法添加
- 给用户充足的时间考虑升级
- 减少用户挫败感

### 2. 一键升级

**便捷操作**：
- 所有提示都包含升级按钮
- 点击后直接跳转到会员中心
- 或直接打开支付对话框

**好处**：
- 减少操作步骤
- 提高转化率
- 改善用户体验

### 3. 智能推荐

**个性化推荐**：
- 根据当前车辆数量推荐合适等级
- 避免推荐过高或过低的等级
- 节省用户选择时间

**好处**：
- 减少决策负担
- 提高选择准确性
- 增加用户满意度

### 4. 灵活选择

**自主决策**：
- 提供所有等级供选择
- 支持提前升级到更高等级
- 满足不同业务需求

**好处**：
- 尊重用户选择
- 适应业务发展
- 提高灵活性

---

## 🔒 安全机制

### 1. 前后端双重检查

**前端检查**：
- 提交前检查，提供友好提示
- 减少无效请求
- 改善用户体验

**后端检查（触发器）**：
- 数据库层面强制检查
- 防止绕过前端检查
- 确保数据一致性

### 2. 权限控制

**RLS策略**：
- 只能查看自己车行的车辆
- 只能为自己车行添加车辆
- 防止越权操作

**触发器权限**：
- 使用SECURITY DEFINER
- 以数据库所有者权限运行
- 确保检查逻辑正确执行

### 3. 数据完整性

**触发器保护**：
- 阻止超限的INSERT操作
- 阻止将车辆状态改为in_stock时超限
- 保证数据库中的数据始终符合规则

---

## 📝 注意事项

### 1. 车辆状态

**只限制in_stock状态**：
- 在售车辆（in_stock）计入限制
- 已售车辆（sold）不计入限制
- 预留车辆（reserved）不计入限制

**原因**：
- 会员费用基于在售车辆数量
- 已售车辆不占用展示资源
- 避免历史数据影响当前业务

### 2. 会员等级变化

**升级后立即生效**：
- 支付成功后自动更新会员等级
- 车辆数量限制立即调整
- 可以立即添加更多车辆

**降级处理**：
- 会员到期后不会自动降级
- 超出新等级限制的车辆仍可保留
- 但无法添加新车辆，直到升级或减少车辆

### 3. 免费期

**免费期限制**：
- 免费期也受车辆数量限制
- 限制根据初始化时的车辆数量确定
- 免费期结束后需要续费才能继续使用

### 4. 性能考虑

**触发器性能**：
- 每次INSERT/UPDATE都会触发检查
- 检查逻辑简单，性能影响很小
- 使用索引优化查询速度

**前端缓存**：
- 加载页面时一次性获取限制信息
- 避免每次操作都查询
- 提交后刷新限制信息

---

## 🚀 未来优化

### 1. 批量导入

**问题**：
- 批量导入车辆时可能超限
- 需要特殊处理

**解决方案**：
- 导入前检查总数量
- 提示用户需要的会员等级
- 提供一键升级功能

### 2. 临时超限

**场景**：
- 短期内车辆数量激增
- 不想立即升级会员

**解决方案**：
- 提供临时超限额度（如+5台）
- 收取额外费用
- 限制使用时间（如7天）

### 3. 会员等级自动调整

**场景**：
- 车辆数量长期低于当前等级
- 浪费会员费用

**解决方案**：
- 续费时提示降级选项
- 节省费用
- 提高用户满意度

### 4. 统计分析

**功能**：
- 统计车辆数量变化趋势
- 预测未来需要的会员等级
- 提供升级建议

**好处**：
- 帮助用户规划业务
- 提高会员转化率
- 增加平台价值

---

## 📚 相关文档

- [会员制系统设计](./MEMBERSHIP_SYSTEM_DESIGN.md)
- [会员初始化功能](./MEMBERSHIP_INITIALIZATION_GUIDE.md)
- [会员RLS权限修复](./MEMBERSHIP_RLS_FIX.md)
- [扫码支付实现](./QRCODE_PAYMENT_IMPLEMENTATION.md)

---

**文档版本**：v1.0  
**最后更新**：2026-01-19  
**适用系统**：二手车销售管理系统 v2.0+
