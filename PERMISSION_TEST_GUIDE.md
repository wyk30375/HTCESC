# 权限系统测试指南

## 测试目的
验证系统的权限控制是否按照需求正确实施：
- 员工可以录入新数据，但不能修改已有数据
- 管理员拥有最高权限，可以修改所有数据

## 测试准备

### 1. 创建测试账号

**管理员账号**（第一个注册的用户）：
- 用户名：admin
- 密码：admin123

**员工账号**（第二个注册的用户）：
- 用户名：employee
- 密码：employee123

### 2. 设置员工角色
1. 使用管理员账号登录
2. 进入"用户管理"页面
3. 将 employee 用户的角色设置为"员工"

## 测试用例

### 测试用例 1：员工录入新车辆
**测试步骤**：
1. 使用员工账号登录
2. 进入"车辆管理"页面
3. 点击"车辆入库"按钮
4. 填写车辆信息并提交

**预期结果**：
- ✅ 可以成功打开车辆入库对话框
- ✅ 可以填写所有字段
- ✅ 可以上传车辆照片
- ✅ 提交后成功创建新车辆
- ✅ 页面显示"车辆已入库"提示

### 测试用例 2：员工尝试修改已有车辆
**测试步骤**：
1. 使用员工账号登录
2. 进入"车辆管理"页面
3. 查看车辆列表中的编辑按钮

**预期结果**：
- ✅ 页面顶部显示"员工权限：可录入新车辆，不可修改已有数据"提示
- ✅ 编辑按钮显示为锁定图标（灰色）
- ✅ 点击锁定图标时显示"只有管理员可以修改已有车辆信息"提示
- ✅ 无法打开编辑对话框

### 测试用例 3：员工查看员工管理
**测试步骤**：
1. 使用员工账号登录
2. 进入"员工管理"页面

**预期结果**：
- ✅ 可以查看员工列表
- ✅ 页面顶部显示"员工权限：仅查看，不可修改"提示
- ✅ 没有"添加员工"按钮
- ✅ 操作列显示锁定图标
- ✅ 点击锁定图标时显示权限不足提示

### 测试用例 4：管理员修改车辆信息
**测试步骤**：
1. 使用管理员账号登录
2. 进入"车辆管理"页面
3. 点击任意车辆的编辑按钮
4. 修改车辆信息并提交

**预期结果**：
- ✅ 可以成功打开编辑对话框
- ✅ 可以修改所有字段
- ✅ 提交后成功更新车辆信息
- ✅ 页面显示"车辆信息已更新"提示

### 测试用例 5：管理员管理员工
**测试步骤**：
1. 使用管理员账号登录
2. 进入"员工管理"页面
3. 点击"添加员工"按钮
4. 填写员工信息并提交

**预期结果**：
- ✅ 可以看到"添加员工"按钮
- ✅ 可以成功打开添加员工对话框
- ✅ 可以填写所有字段
- ✅ 提交后成功创建新员工
- ✅ 可以点击"角色"按钮编辑员工角色
- ✅ 可以点击编辑按钮修改员工信息
- ✅ 可以点击删除按钮停用员工

### 测试用例 6：数据库层面权限验证
**测试步骤**：
1. 使用员工账号登录
2. 打开浏览器开发者工具（F12）
3. 尝试通过 API 直接修改车辆信息

**预期结果**：
- ✅ 即使绕过前端验证，数据库 RLS 策略也会阻止修改操作
- ✅ 控制台显示权限错误信息
- ✅ 数据库中的数据不会被修改

### 测试用例 7：图片上传权限
**测试步骤**：
1. 使用员工账号登录
2. 进入"车辆管理"页面
3. 点击"车辆入库"
4. 上传车辆照片

**预期结果**：
- ✅ 员工可以成功上传图片
- ✅ 图片自动压缩至 1MB 以下
- ✅ 图片成功保存到存储桶

## 测试检查清单

### 员工权限检查
- [ ] 可以录入新车辆
- [ ] 可以添加车辆成本
- [ ] 可以上传车辆照片
- [ ] 不能修改已有车辆
- [ ] 不能删除车辆
- [ ] 不能管理员工信息
- [ ] 不能编辑员工角色
- [ ] 可以查看所有数据

### 管理员权限检查
- [ ] 可以录入新车辆
- [ ] 可以修改已有车辆
- [ ] 可以删除车辆
- [ ] 可以管理员工信息
- [ ] 可以编辑员工角色
- [ ] 可以管理用户权限
- [ ] 可以更新和删除图片
- [ ] 可以查看所有数据

### UI 提示检查
- [ ] 员工登录时车辆管理页面显示权限提示
- [ ] 员工登录时员工管理页面显示权限提示
- [ ] 编辑按钮显示为锁定图标（员工）
- [ ] 点击锁定图标显示权限不足提示
- [ ] 管理员登录时显示正常编辑按钮

### 数据库策略检查
- [ ] 车辆表策略正确
- [ ] 车辆成本表策略正确
- [ ] 销售记录表策略正确
- [ ] 费用记录表策略正确
- [ ] 员工表策略正确
- [ ] 员工角色表策略正确
- [ ] 存储桶策略正确

## 测试结果记录

### 测试环境
- 测试日期：____________________
- 测试人员：____________________
- 系统版本：v1.0

### 测试结果
- [ ] 所有测试用例通过
- [ ] 部分测试用例失败（请记录失败用例）
- [ ] 发现新问题（请详细描述）

### 问题记录
如有问题，请在此记录：

1. ___________________________________________
2. ___________________________________________
3. ___________________________________________

## 注意事项

1. **测试顺序**：建议按照测试用例顺序进行测试
2. **数据清理**：测试完成后可以删除测试数据
3. **浏览器缓存**：如遇到问题，尝试清除浏览器缓存后重试
4. **权限刷新**：修改用户角色后，需要重新登录才能生效
5. **数据库验证**：可以通过 Supabase 控制台查看数据库中的实际数据

## 常见问题

### Q1：修改用户角色后权限没有变化？
**A**：需要退出登录后重新登录，系统会重新加载用户权限。

### Q2：员工可以看到编辑按钮但无法点击？
**A**：这是正常的，编辑按钮会显示为锁定图标，点击时会提示权限不足。

### Q3：如何验证数据库层面的权限控制？
**A**：可以通过浏览器开发者工具的 Network 标签查看 API 请求，或者直接在 Supabase 控制台执行 SQL 查询。

### Q4：第一个用户一定是管理员吗？
**A**：是的，系统通过数据库触发器自动将第一个注册的用户设置为管理员。

### Q5：可以有多个管理员吗？
**A**：可以，管理员可以在"用户管理"页面将其他用户设置为管理员。
