# 员工密码修改功能说明

## 功能概述

所有员工（包括管理员）都可以修改自己的登录密码，提升账号安全性。

---

## 适用人群

✅ **所有员工**：普通员工和管理员都可以使用
- 管理员（admin）
- 普通员工（employee）
- 超级管理员（super_admin）

---

## 功能入口

### 1. 员工个人设置页面（推荐）
- **路径**：`/profile`
- **菜单位置**：侧边栏 → 系统设置 → 个人设置
- **适用人群**：所有员工
- **功能**：
  - 查看个人信息（用户名、角色、邮箱、手机号）
  - 修改登录密码
  - 查看安全提示

### 2. 车行信息页面
- **路径**：`/dealership-settings`
- **菜单位置**：侧边栏 → 系统设置 → 车行信息
- **适用人群**：管理员
- **功能**：
  - 管理车行基本信息
  - 修改登录密码（在"账号安全"部分）

---

## 使用方法

### 步骤 1：进入个人设置
1. 登录系统
2. 点击侧边栏"个人设置"菜单
3. 找到"账号安全"卡片

### 步骤 2：填写密码信息
- **当前密码**：输入您现在使用的密码
- **新密码**：输入新密码（至少6位）
- **确认新密码**：再次输入新密码

### 步骤 3：提交修改
1. 点击"修改密码"按钮
2. 等待系统验证和处理
3. 看到"密码修改成功！"提示

### 步骤 4：使用新密码
- 当前会话仍然有效，无需重新登录
- 下次登录时使用新密码

---

## 密码要求

### 基本要求
- ✅ 长度至少为 6 位
- ✅ 不能与当前密码相同
- ✅ 两次输入的新密码必须一致

### 安全建议
- 🔒 使用字母、数字和符号组合
- 🔒 不要使用过于简单的密码（如：123456、password）
- 🔒 定期修改密码（建议每3-6个月）
- 🔒 不要与他人分享密码
- 🔒 不同系统使用不同密码

---

## 安全验证

### 前端验证
1. 检查所有字段是否填写
2. 检查新密码长度（至少6位）
3. 检查两次输入的新密码是否一致
4. 检查新密码是否与旧密码相同

### 后端验证
1. 验证用户是否存在
2. 验证当前密码是否正确
3. 执行密码更新
4. 更新密码记录

---

## 常见问题

### Q: 忘记当前密码怎么办？
A: 请联系管理员重置密码。管理员可以在"员工管理"页面为您重置密码。

### Q: 修改密码后需要重新登录吗？
A: 不需要。当前会话仍然有效，下次登录时使用新密码即可。

### Q: 新密码有什么要求？
A: 
- 长度至少为6位
- 不能与当前密码相同
- 建议使用字母、数字和符号组合

### Q: 为什么要输入当前密码？
A: 这是为了安全考虑，确保是账号所有者本人在修改密码，防止他人在您离开电脑时修改密码。

### Q: 修改密码失败怎么办？
A: 请检查：
1. 当前密码是否正确
2. 新密码是否符合要求（至少6位）
3. 两次输入的新密码是否一致
4. 网络连接是否正常

如果仍然失败，请联系管理员或技术支持。

### Q: 员工和管理员修改密码有什么区别？
A: 没有区别。所有用户使用相同的密码修改功能，都需要验证当前密码。

---

## 技术实现

### Edge Function
- **函数名称**：`change-password`
- **功能**：处理所有用户的密码修改请求
- **验证**：
  - 验证用户是否存在
  - 通过 Supabase Auth 验证当前密码
  - 使用 Admin API 更新密码
  - 更新 profiles 表记录

### 调用方式
```typescript
const { data, error } = await supabase.functions.invoke('change-password', {
  body: {
    username: profile.username,
    oldPassword: oldPassword,
    newPassword: newPassword,
  },
});
```

### 安全特性
- ✅ 必须验证当前密码
- ✅ 使用 Supabase Auth 进行密码验证
- ✅ 使用 Admin API 安全更新密码
- ✅ 前后端双重验证
- ✅ 详细的错误提示

---

## 页面功能对比

| 功能 | 个人设置页面 | 车行信息页面 |
|------|------------|------------|
| 适用人群 | 所有员工 | 仅管理员 |
| 查看个人信息 | ✅ | ❌ |
| 修改密码 | ✅ | ✅ |
| 管理车行信息 | ❌ | ✅ |
| 安全提示 | ✅ | ❌ |
| 菜单位置 | 系统设置 | 系统设置 |

---

## 相关文件

### 前端文件
- `src/pages/EmployeeProfile.tsx` - 员工个人设置页面
- `src/pages/DealershipSettings.tsx` - 车行信息页面（包含密码修改）
- `src/routes.tsx` - 路由配置
- `src/components/layouts/Layout.tsx` - 侧边栏导航配置

### 后端文件
- `supabase/functions/change-password/index.ts` - 密码修改 Edge Function

### 文档文件
- `EMPLOYEE_PASSWORD_CHANGE.md` - 本文档
- `PASSWORD_CHANGE_MIGRATION.md` - 密码修改功能迁移说明

---

## 更新日志

### v2.1.0 (2026-01-10)
- ✅ 创建通用的密码修改 Edge Function（change-password）
- ✅ 新增员工个人设置页面（/profile）
- ✅ 在侧边栏添加"个人设置"菜单项
- ✅ 所有员工都可以修改自己的密码
- ✅ 显示个人信息（用户名、角色、邮箱、手机号）
- ✅ 添加安全提示卡片
- ✅ 优化用户体验和安全性

---

## 安全建议

### 对员工
1. **定期修改密码**：建议每3-6个月修改一次
2. **使用强密码**：包含字母、数字和符号
3. **保护密码**：不要与他人分享
4. **及时报告**：发现账号异常立即修改密码并报告管理员

### 对管理员
1. **密码策略**：建议制定公司密码策略
2. **定期提醒**：提醒员工定期修改密码
3. **安全培训**：对员工进行密码安全培训
4. **监控异常**：关注账号异常登录情况

---

## 后续优化建议

1. **密码强度检测**
   - 实时显示密码强度（弱/中/强）
   - 提供密码强度建议
   - 禁止使用弱密码

2. **密码历史记录**
   - 记录最近使用的密码
   - 防止重复使用最近的密码
   - 提高账号安全性

3. **密码过期提醒**
   - 设置密码有效期
   - 到期前提醒用户修改
   - 过期后强制修改

4. **双因素认证**
   - 手机验证码
   - 邮箱验证码
   - 提高账号安全性

5. **登录日志**
   - 记录登录时间和IP
   - 显示最近登录记录
   - 异常登录提醒
