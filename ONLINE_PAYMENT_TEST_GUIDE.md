# 在线支付功能测试指南

## 🎯 测试目标

验证在线扫码支付功能是否正常工作，包括：
1. 创建支付订单
2. 生成支付二维码
3. 模拟支付成功
4. 自动开通会员资格

---

## 📋 测试前准备

### 1. 确认环境
- ✅ 数据库迁移已执行（payment_orders表已创建）
- ✅ Edge Function已部署（payment-handler）
- ✅ 前端代码已更新
- ✅ 系统正常运行

### 2. 准备测试账号
- 车商管理员账号（admin角色）
- 确保车商已审核通过
- 确保车商有会员记录

---

## 🧪 测试步骤

### 测试1：访问会员中心

#### 操作步骤
1. 使用车商管理员账号登录
2. 点击左侧菜单"会员中心"
3. 滚动到"在线续费"卡片

#### 预期结果
- ✅ 页面正常加载
- ✅ 显示四个会员等级卡片
- ✅ 每个卡片显示等级名称、价格、"扫码支付"按钮
- ✅ 显示提示信息："支付成功后，会员资格将自动开通，无需等待人工审核"

---

### 测试2：打开支付对话框

#### 操作步骤
1. 点击任意会员等级卡片（例如：三级会员）
2. 观察支付对话框

#### 预期结果
- ✅ 弹出支付对话框
- ✅ 对话框标题："扫码支付"
- ✅ 显示选中的会员等级徽章
- ✅ 显示会员价格（例如：¥198）
- ✅ 显示提示："点击'生成支付码'后，请在30分钟内完成支付"
- ✅ 显示"生成支付码"按钮

---

### 测试3：生成支付订单

#### 操作步骤
1. 点击"生成支付码"按钮
2. 等待订单创建

#### 预期结果
- ✅ 按钮显示"生成中..."和加载动画
- ✅ 约1-2秒后显示成功提示："订单创建成功，请扫码支付"
- ✅ 显示订单号（格式：PO20260110xxxxxx）
- ✅ 显示支付金额
- ✅ 显示二维码图片
- ✅ 显示订单有效期（当前时间+30分钟）
- ✅ 显示"等待支付中"提示
- ✅ 显示黄色测试模式提示框
- ✅ 显示"模拟支付成功"按钮

#### 验证数据库
```sql
-- 查询刚创建的订单
SELECT * FROM payment_orders 
WHERE dealership_id = '车商ID'
ORDER BY created_at DESC 
LIMIT 1;
```

**检查点：**
- [ ] 订单记录已创建
- [ ] status = 'pending'
- [ ] qr_code_url 不为空
- [ ] expired_at = created_at + 30分钟

---

### 测试4：模拟支付成功

#### 操作步骤
1. 在支付对话框中找到黄色测试模式提示框
2. 点击"模拟支付成功"按钮
3. 等待处理

#### 预期结果
- ✅ 按钮显示"处理中..."和加载动画
- ✅ 约1-2秒后显示成功提示："支付成功！会员已开通"
- ✅ 支付对话框自动关闭
- ✅ 会员中心页面自动刷新
- ✅ 会员状态更新（如果是续费，会员期限延长1年）

#### 验证数据库
```sql
-- 1. 查询订单状态
SELECT * FROM payment_orders 
WHERE order_no = '订单号';

-- 2. 查询会员记录
SELECT * FROM dealership_memberships 
WHERE dealership_id = '车商ID'
ORDER BY created_at DESC 
LIMIT 1;

-- 3. 查询支付记录
SELECT * FROM membership_payments 
WHERE dealership_id = '车商ID'
ORDER BY created_at DESC 
LIMIT 1;
```

**检查点：**
- [ ] 订单状态更新为 'paid'
- [ ] paid_at 已设置
- [ ] 新的会员记录已创建
- [ ] 会员 end_date = start_date + 1年
- [ ] 会员 status = 'active'
- [ ] 支付记录已创建
- [ ] 支付记录 payment_status = 'completed'
- [ ] 支付记录 transaction_id = 订单号

---

### 测试5：支付状态轮询

#### 操作步骤
1. 生成支付订单后
2. 不点击"模拟支付成功"按钮
3. 在另一个浏览器标签页或使用SQL手动更新订单状态：

```sql
-- 手动模拟支付成功
SELECT process_payment_success('订单号');
```

4. 观察原支付对话框

#### 预期结果
- ✅ 约3秒后（轮询间隔）自动检测到支付成功
- ✅ 显示成功提示："支付成功！会员已开通"
- ✅ 支付对话框自动关闭
- ✅ 会员中心页面自动刷新

---

### 测试6：订单过期处理

#### 操作步骤
1. 生成支付订单
2. 手动更新订单过期时间：

```sql
-- 设置订单为已过期
UPDATE payment_orders 
SET expired_at = NOW() - INTERVAL '1 minute',
    status = 'expired'
WHERE order_no = '订单号';
```

3. 观察支付对话框

#### 预期结果
- ✅ 约3秒后（轮询间隔）检测到订单已过期
- ✅ 显示错误提示："订单已失效"
- ✅ 停止轮询检查

---

### 测试7：重复支付防护

#### 操作步骤
1. 生成支付订单并完成支付
2. 尝试再次对同一订单调用支付成功函数：

```sql
-- 尝试重复支付
SELECT process_payment_success('已支付的订单号');
```

#### 预期结果
- ✅ 返回错误："订单已支付"
- ✅ 不会创建重复的会员记录
- ✅ 不会创建重复的支付记录

---

### 测试8：多会员等级测试

#### 操作步骤
1. 分别测试四个会员等级的支付流程：
   - 三级会员（¥198）
   - 二级会员（¥365）
   - 一级会员（¥580）
   - 金牌会员（¥980）

#### 预期结果
- ✅ 每个等级都能正常创建订单
- ✅ 订单金额正确
- ✅ 支付成功后创建对应等级的会员记录

---

### 测试9：并发订单测试

#### 操作步骤
1. 快速连续创建多个订单（不支付）
2. 查看订单列表

#### 预期结果
- ✅ 每个订单都有唯一的订单号
- ✅ 所有订单都正常创建
- ✅ 没有订单号重复

---

### 测试10：权限测试

#### 操作步骤
1. 使用员工账号登录
2. 尝试访问会员中心

#### 预期结果
- ✅ 员工无法看到"会员中心"菜单
- ✅ 直接访问 /membership 路径时被拦截

---

## ✅ 测试检查清单

### 功能测试
- [ ] 会员中心页面正常显示
- [ ] 在线续费卡片正常显示
- [ ] 支付对话框正常打开
- [ ] 支付订单正常创建
- [ ] 二维码正常生成
- [ ] 模拟支付成功
- [ ] 会员资格自动开通
- [ ] 支付记录正常创建

### 数据库测试
- [ ] payment_orders表正常工作
- [ ] 订单号唯一性保证
- [ ] 订单状态正确更新
- [ ] 会员记录正确创建
- [ ] 支付记录正确创建

### 边界测试
- [ ] 订单过期处理正常
- [ ] 重复支付防护正常
- [ ] 并发订单处理正常

### 权限测试
- [ ] 管理员可以访问会员中心
- [ ] 员工无法访问会员中心
- [ ] RLS策略正常工作

### 用户体验测试
- [ ] 加载状态显示正常
- [ ] 错误提示清晰明确
- [ ] 成功提示及时显示
- [ ] 页面自动刷新正常

---

## 🐛 常见问题排查

### 问题1：订单创建失败

**症状**：点击"生成支付码"后显示错误

**排查步骤**：
1. 打开浏览器开发者工具，查看Console错误
2. 检查Network请求，查看Edge Function响应
3. 检查数据库是否有payment_orders表
4. 检查Edge Function是否正常部署

```bash
# 检查Edge Function状态
supabase functions list
```

### 问题2：二维码不显示

**症状**：订单创建成功，但二维码不显示

**排查步骤**：
1. 检查qr_code_url字段是否有值
2. 检查图片URL是否可访问
3. 检查网络连接

```sql
-- 查询二维码URL
SELECT qr_code_url FROM payment_orders WHERE order_no = '订单号';
```

### 问题3：支付后没有自动开通

**症状**：点击"模拟支付成功"后没有反应

**排查步骤**：
1. 检查Console是否有错误
2. 检查process_payment_success函数是否正常
3. 手动执行SQL验证

```sql
-- 手动执行支付成功处理
SELECT process_payment_success('订单号');
```

### 问题4：轮询不工作

**症状**：手动更新订单状态后，前端没有自动检测

**排查步骤**：
1. 检查checkingPayment状态是否为true
2. 检查checkOrderStatus API是否正常
3. 检查轮询间隔设置（3秒）

---

## 📊 测试报告模板

### 测试环境
- 测试日期：____
- 测试人员：____
- 系统版本：____
- 数据库版本：____

### 测试结果

| 测试项 | 状态 | 备注 |
|-------|------|------|
| 会员中心显示 | ✅/❌ | |
| 支付对话框 | ✅/❌ | |
| 订单创建 | ✅/❌ | |
| 二维码生成 | ✅/❌ | |
| 模拟支付 | ✅/❌ | |
| 会员开通 | ✅/❌ | |
| 支付轮询 | ✅/❌ | |
| 订单过期 | ✅/❌ | |
| 重复支付防护 | ✅/❌ | |
| 权限控制 | ✅/❌ | |

### 发现的问题
1. 
2. 
3. 

### 建议改进
1. 
2. 
3. 

---

**文档版本**：v1.0  
**最后更新**：2026-01-10  
**适用系统**：二手车销售管理系统 v2.0+
