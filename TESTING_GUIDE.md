# 多车行平台测试指南

## 测试场景

### 场景 1：创建新车行并注册为管理员
1. 访问 http://localhost:5173/register
2. 选择"创建新车行"标签
3. 填写车行信息：
   - 车行名称：测试车行A
   - 车行代码：test-a
   - 联系人：张三
   - 联系电话：13800138000
   - 地址：测试地址A
4. 填写管理员账号：
   - 用户名：admin-a
   - 密码：123456
   - 确认密码：123456
   - 手机号：13800138000
5. 点击"创建车行并注册"
6. 验证：
   - ✅ 自动登录成功
   - ✅ 侧边栏显示"测试车行A"和"test-a"
   - ✅ 可以访问所有功能页面
   - ✅ 可以创建员工、车辆、销售等数据

### 场景 2：创建第二个车行
1. 退出登录
2. 访问 http://localhost:5173/register
3. 创建第二个车行：
   - 车行名称：测试车行B
   - 车行代码：test-b
   - 管理员用户名：admin-b
   - 密码：123456
4. 验证：
   - ✅ 自动登录成功
   - ✅ 侧边栏显示"测试车行B"和"test-b"
   - ✅ 看不到车行A的任何数据

### 场景 3：员工加入现有车行
1. 退出登录
2. 访问 http://localhost:5173/register
3. 选择"加入车行"标签
4. 填写信息：
   - 车行代码：test-a
   - 用户名：employee-a1
   - 密码：123456
   - 确认密码：123456
5. 验证：
   - ✅ 自动登录成功
   - ✅ 侧边栏显示"测试车行A"
   - ✅ 可以看到车行A的数据
   - ✅ 看不到车行B的数据
   - ✅ 没有"用户管理"菜单（因为是员工角色）

### 场景 4：数据隔离测试
1. 使用 admin-a 登录（测试车行A）
2. 创建一些测试数据：
   - 添加员工：员工A1
   - 添加车辆：车辆A1（车架号：TEST01）
   - 创建销售记录
3. 退出登录
4. 使用 admin-b 登录（测试车行B）
5. 验证：
   - ✅ 看不到车行A的员工
   - ✅ 看不到车行A的车辆
   - ✅ 看不到车行A的销售记录
   - ✅ 统计数据为空或只显示车行B的数据

### 场景 5：Super Admin 功能测试
1. 使用数据库创建 super_admin 账号：
```sql
-- 在 Supabase SQL Editor 中执行
UPDATE profiles 
SET role = 'super_admin' 
WHERE username = 'admin';  -- 将默认管理员设置为超级管理员
```

2. 使用 super_admin 账号登录
3. 验证：
   - ✅ 侧边栏显示"车行管理"菜单
   - ✅ 可以访问 /dealerships 页面
   - ✅ 可以看到所有车行列表
   - ✅ 可以创建、编辑、启用/停用车行
   - ✅ 可以查看所有车行的数据

### 场景 6：权限控制测试
1. 使用员工账号登录
2. 尝试访问：
   - /admin - 应该被拒绝或看不到菜单
   - /dealerships - 应该显示"无权限"提示
3. 使用管理员账号登录
4. 验证：
   - ✅ 可以访问 /admin（用户管理）
   - ✅ 看不到"车行管理"菜单
   - ✅ 访问 /dealerships 显示"无权限"提示

## 预期结果

### 数据隔离
- ✅ 每个车行只能看到自己的数据
- ✅ 员工只能看到所属车行的数据
- ✅ 管理员只能管理本车行的用户
- ✅ Super Admin 可以看到所有数据

### 权限控制
- ✅ employee: 只能查看和操作本车行数据
- ✅ admin: 可以管理本车行用户和数据
- ✅ super_admin: 可以管理所有车行和数据

### 用户体验
- ✅ 侧边栏显示当前车行名称
- ✅ 注册流程简单明了
- ✅ 自动登录无需手动输入
- ✅ 车行代码作为加入凭证

## 测试数据清理

如果需要清理测试数据，在 Supabase SQL Editor 中执行：

```sql
-- 删除测试车行（会级联删除所有相关数据）
DELETE FROM dealerships WHERE code IN ('test-a', 'test-b');

-- 或者只删除测试用户
DELETE FROM auth.users WHERE email LIKE '%test-%';
```

## 已知问题和注意事项

1. **车行代码唯一性**：车行代码必须唯一，创建时会自动转换为小写
2. **用户名唯一性**：用户名在整个平台上必须唯一（通过邮箱实现）
3. **数据迁移**：现有数据已自动迁移到默认车行"易驰汽车"（code: yichi）
4. **RLS 策略**：所有数据查询都通过 RLS 策略自动过滤，无需手动添加 where 条件
5. **性能优化**：已为所有 dealership_id 字段添加索引

## 下一步计划

- [ ] 添加车行切换功能（如果用户属于多个车行）
- [ ] 添加车行统计信息（员工数、车辆数、销售额等）
- [ ] 优化移动端车行注册体验
- [ ] 添加车行Logo上传功能
- [ ] 实现车行间数据导出功能
