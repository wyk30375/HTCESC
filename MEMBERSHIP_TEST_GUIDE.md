# 会员制系统测试指南

## 🎯 测试目标

验证会员制系统的核心功能是否正常工作，包括：
1. 车商审核通过时自动初始化会员
2. 车辆数量变化时自动更新会员等级
3. 会员中心页面正确显示会员信息

## 📋 测试前准备

### 1. 确认系统环境
- 确保数据库迁移已执行
- 确保前端代码已更新
- 确保系统正常运行

### 2. 准备测试账号
- 平台管理员账号（super_admin）
- 车商管理员账号（admin）

## 🧪 测试步骤

### 测试1：新车商入驻会员初始化

#### 步骤
1. 使用平台管理员账号登录
2. 进入"车行管理"页面
3. 找到一个"待审核"状态的车商
4. 点击"审核通过"按钮
5. 等待审核完成

#### 预期结果
- ✅ 审核成功提示
- ✅ 车商状态变为"已激活"
- ✅ 控制台输出"会员信息初始化成功"

#### 验证方法
```sql
-- 在Supabase SQL Editor中执行
SELECT 
  dm.*,
  mt.tier_name,
  mt.annual_fee,
  d.name as dealership_name
FROM dealership_memberships dm
JOIN membership_tiers mt ON dm.tier_id = mt.id
JOIN dealerships d ON dm.dealership_id = d.id
WHERE d.id = '车商ID'
ORDER BY dm.created_at DESC;
```

#### 检查点
- [ ] 会员记录已创建
- [ ] is_trial = true（免费期）
- [ ] trial_end_date = 当前日期 + 6个月
- [ ] end_date = 当前日期 + 6个月
- [ ] status = 'active'
- [ ] tier_id 对应正确的会员等级

---

### 测试2：车辆入库触发等级更新

#### 步骤
1. 使用车商管理员账号登录
2. 进入"会员中心"页面，记录当前会员等级和车辆数量
3. 进入"车辆管理"页面
4. 点击"车辆入库"，添加多辆在售车辆
5. 保存车辆信息
6. 返回"会员中心"页面

#### 预期结果
- ✅ 车辆成功入库
- ✅ 会员中心显示的车辆数量增加
- ✅ 如果车辆数量跨越等级边界，会员等级自动更新

#### 测试场景

**场景A：从三级升级到二级**
- 初始状态：10台车，三级会员
- 操作：添加15台车
- 预期：25台车，自动升级为二级会员

**场景B：从二级升级到一级**
- 初始状态：30台车，二级会员
- 操作：添加25台车
- 预期：55台车，自动升级为一级会员

**场景C：从一级升级到金牌**
- 初始状态：100台车，一级会员
- 操作：添加60台车
- 预期：160台车，自动升级为金牌会员

#### 验证方法
```sql
-- 检查会员等级是否更新
SELECT 
  dm.id,
  mt.tier_name,
  mt.tier_level,
  (SELECT COUNT(*) FROM vehicles WHERE dealership_id = dm.dealership_id AND status = 'available') as vehicle_count
FROM dealership_memberships dm
JOIN membership_tiers mt ON dm.tier_id = mt.id
WHERE dm.dealership_id = '车商ID'
  AND dm.status = 'active'
ORDER BY dm.created_at DESC
LIMIT 1;
```

#### 检查点
- [ ] 车辆数量统计正确
- [ ] 会员等级自动更新
- [ ] 会员中心页面显示正确

---

### 测试3：车辆销售触发等级更新

#### 步骤
1. 使用车商管理员账号登录
2. 进入"会员中心"页面，记录当前会员等级和车辆数量
3. 进入"销售管理"页面
4. 记录多笔销售（将在售车辆变为已售）
5. 返回"会员中心"页面

#### 预期结果
- ✅ 销售记录成功创建
- ✅ 车辆状态变为"已售"
- ✅ 会员中心显示的车辆数量减少
- ✅ 如果车辆数量跨越等级边界，会员等级自动更新

#### 测试场景

**场景A：从二级降级到三级**
- 初始状态：25台车，二级会员
- 操作：销售10台车
- 预期：15台车，等级仍为二级（降级在续费时生效）

**注意**：降级不会立即生效，会在下次续费时生效。

#### 验证方法
```sql
-- 检查车辆数量变化
SELECT 
  COUNT(*) FILTER (WHERE status = 'available') as available_count,
  COUNT(*) FILTER (WHERE status = 'sold') as sold_count,
  COUNT(*) as total_count
FROM vehicles
WHERE dealership_id = '车商ID';
```

#### 检查点
- [ ] 在售车辆数量减少
- [ ] 已售车辆数量增加
- [ ] 会员中心页面显示正确

---

### 测试4：会员中心页面功能

#### 步骤
1. 使用车商管理员账号登录
2. 点击侧边栏"会员中心"菜单
3. 查看页面各个部分

#### 预期结果

**1. 当前会员状态卡片**
- ✅ 显示会员等级（带颜色徽章）
- ✅ 显示在售车辆数量
- ✅ 显示会员剩余天数
- ✅ 显示会员状态（免费期/正常/已到期）

**2. 会员等级说明卡片**
- ✅ 显示所有4个会员等级
- ✅ 显示每个等级的价格和车辆数量范围
- ✅ 当前等级高亮显示

**3. 到期提醒**
- ✅ 免费期剩余30天内显示提醒
- ✅ 会员到期前30天显示提醒

**4. 等级变化提示**
- ✅ 车辆数量对应的等级与当前等级不符时显示提示

**5. 会员权益说明**
- ✅ 显示所有会员权益列表

**6. 免费期说明**
- ✅ 显示免费期规则说明

#### 检查点
- [ ] 所有卡片正常显示
- [ ] 数据准确无误
- [ ] 样式美观
- [ ] 响应式布局正常

---

### 测试5：权限控制

#### 步骤
1. 使用员工账号登录
2. 尝试访问会员中心页面

#### 预期结果
- ✅ 侧边栏不显示"会员中心"菜单
- ✅ 直接访问 /membership 路径时被拦截或显示无权限

#### 检查点
- [ ] 员工无法访问会员中心
- [ ] 管理员可以访问会员中心

---

### 测试6：边界值测试

#### 测试车辆数量边界值

**边界值**：20、21、50、51、150、151

#### 测试场景

| 车辆数量 | 预期等级 |
|---------|---------|
| 0 | 三级会员 |
| 10 | 三级会员 |
| 20 | 三级会员 |
| 21 | 二级会员 |
| 30 | 二级会员 |
| 50 | 二级会员 |
| 51 | 一级会员 |
| 100 | 一级会员 |
| 150 | 一级会员 |
| 151 | 金牌会员 |
| 200 | 金牌会员 |

#### 验证方法
```sql
-- 测试等级计算函数
SELECT calculate_membership_tier(0);  -- 应返回三级会员ID
SELECT calculate_membership_tier(20); -- 应返回三级会员ID
SELECT calculate_membership_tier(21); -- 应返回二级会员ID
SELECT calculate_membership_tier(50); -- 应返回二级会员ID
SELECT calculate_membership_tier(51); -- 应返回一级会员ID
SELECT calculate_membership_tier(150); -- 应返回一级会员ID
SELECT calculate_membership_tier(151); -- 应返回金牌会员ID
```

#### 检查点
- [ ] 所有边界值测试通过
- [ ] 等级判定准确

---

## 🐛 常见问题排查

### 问题1：会员信息未初始化

**症状**：车商审核通过后，会员中心显示"您还没有会员信息"

**排查步骤**：
1. 检查控制台是否有错误信息
2. 检查数据库是否有会员记录
3. 手动执行初始化函数

```sql
-- 手动初始化会员
SELECT initialize_dealership_membership('车商ID');
```

### 问题2：会员等级未更新

**症状**：车辆数量变化后，会员等级没有自动更新

**排查步骤**：
1. 检查触发器是否存在
```sql
SELECT * FROM pg_trigger WHERE tgname = 'update_membership_on_vehicle_change';
```

2. 手动执行更新函数
```sql
SELECT update_dealership_membership_tier('车商ID');
```

3. 检查车辆状态是否为 'available'
```sql
SELECT status, COUNT(*) FROM vehicles WHERE dealership_id = '车商ID' GROUP BY status;
```

### 问题3：会员中心页面加载失败

**症状**：会员中心页面显示错误或加载中

**排查步骤**：
1. 打开浏览器开发者工具，查看Console错误
2. 检查Network请求是否失败
3. 检查profile.dealership_id是否存在
4. 检查RLS策略是否正确配置

### 问题4：车辆数量统计不准确

**症状**：会员中心显示的车辆数量与实际不符

**排查步骤**：
1. 检查车辆状态
```sql
SELECT 
  status,
  COUNT(*) as count
FROM vehicles
WHERE dealership_id = '车商ID'
GROUP BY status;
```

2. 检查统计函数
```sql
SELECT get_dealership_vehicle_count('车商ID');
```

3. 确认只统计 status = 'available' 的车辆

---

## ✅ 测试检查清单

### 功能测试
- [ ] 车商审核通过时自动初始化会员
- [ ] 车辆入库时自动更新会员等级
- [ ] 车辆销售时自动更新会员等级
- [ ] 会员中心页面正确显示所有信息
- [ ] 会员状态提醒正常显示
- [ ] 等级变化提示正常显示

### 边界测试
- [ ] 车辆数量边界值测试通过
- [ ] 免费期边界测试通过

### 权限测试
- [ ] 管理员可以访问会员中心
- [ ] 员工无法访问会员中心
- [ ] 平台管理员可以查看所有会员信息

### 性能测试
- [ ] 会员中心页面加载速度正常
- [ ] 车辆数量变化时等级更新及时

### UI测试
- [ ] 页面布局美观
- [ ] 响应式设计正常
- [ ] 颜色和徽章显示正确
- [ ] 提示信息清晰明确

---

## 📊 测试报告模板

### 测试环境
- 测试日期：____
- 测试人员：____
- 系统版本：____
- 数据库版本：____

### 测试结果

| 测试项 | 状态 | 备注 |
|-------|------|------|
| 会员初始化 | ✅/❌ | |
| 等级自动更新 | ✅/❌ | |
| 会员中心显示 | ✅/❌ | |
| 边界值测试 | ✅/❌ | |
| 权限控制 | ✅/❌ | |

### 发现的问题
1. 
2. 
3. 

### 建议改进
1. 
2. 
3. 

---

**文档版本**：v1.0  
**最后更新**：2026-01-10  
**适用系统**：二手车销售管理系统 v2.0+
